<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="配置文件文件类型properties与之前使用properties文件的用法一致 yaml简介YAML是YAML Ain&#39;t markup Language 的递归缩写。在开发这种语言时，YAML的意思是Yet Another Markup Language。 非常适合用来做以数据为中心的配置文件 基本语法 key: valuekv之间有空格 大小写敏感 使用缩进表示层级关系 缩进不允许使">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot核心功能 - 学习笔记">
<meta property="og:url" content="http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Clover Blog">
<meta property="og:description" content="配置文件文件类型properties与之前使用properties文件的用法一致 yaml简介YAML是YAML Ain&#39;t markup Language 的递归缩写。在开发这种语言时，YAML的意思是Yet Another Markup Language。 非常适合用来做以数据为中心的配置文件 基本语法 key: valuekv之间有空格 大小写敏感 使用缩进表示层级关系 缩进不允许使">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049118.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271052434.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049137.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049148.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049142.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049154.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049158.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049358.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049496.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049672.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049686.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049036.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049041.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049264.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049460.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049533.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049700.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049909.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049978.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049008.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049481.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049488.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049629.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049188.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049191.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049199.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049536.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049663.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049875.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049332.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049327.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049555.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049574.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049845.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049017.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049192.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049497.png">
<meta property="og:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049795.png">
<meta property="article:published_time" content="2022-01-02T10:06:00.000Z">
<meta property="article:modified_time" content="2023-05-26T09:45:32.850Z">
<meta property="article:author" content="Clover You">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="学习笔记">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringMvc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://qiniu-note-image.ctong.top/note/images/202112271049118.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Spring Boot核心功能 - 学习笔记</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Clover Blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/01/02/Spring-Boot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/01/02/Spring-Boot%E5%9F%BA%E7%A1%80---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=Spring Boot核心功能 - 学习笔记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&is_video=false&description=Spring Boot核心功能 - 学习笔记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Spring Boot核心功能 - 学习笔记&body=Check out this article: http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=Spring Boot核心功能 - 学习笔记&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=Spring Boot核心功能 - 学习笔记"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">文件类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#properties"><span class="toc-number">1.1.1.</span> <span class="toc-text">properties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yaml"><span class="toc-number">1.1.2.</span> <span class="toc-text">yaml</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E7%BB%91%E5%AE%9A%E7%9A%84%E9%85%8D%E7%BD%AE%E6%8F%90%E7%A4%BA"><span class="toc-number">1.2.</span> <span class="toc-text">自定义类绑定的配置提示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E5%BC%80%E5%8F%91"><span class="toc-number">2.</span> <span class="toc-text">Web开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">简单功能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">静态资源访问</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">静态资源目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">静态资源访问原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%89%8D%E7%BC%80"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">静态资源访问前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84%E4%BF%AE%E6%94%B9"><span class="toc-number">2.1.1.4.</span> <span class="toc-text">静态资源路径修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E9%A1%B5%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.5.</span> <span class="toc-text">欢迎页配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Favicon"><span class="toc-number">2.1.1.6.</span> <span class="toc-text">Favicon</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.1.7.</span> <span class="toc-text">静态资源配置原理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86%E9%BB%98%E8%AE%A4%E8%A7%84%E5%88%99%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">2.1.1.7.1.</span> <span class="toc-text">资源处理默认规则核心代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E9%A1%B5%E7%9A%84%E5%A4%84%E7%90%86%E8%A7%84%E5%88%99"><span class="toc-number">2.1.1.7.2.</span> <span class="toc-text">欢迎页的处理规则</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">请求参数处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84"><span class="toc-number">3.1.</span> <span class="toc-text">请求映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rest%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">Rest原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.2.</span> <span class="toc-text">请求映射原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%8F%82%E6%95%B0%E4%B8%8E%E5%9F%BA%E6%9C%AC%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">普通参数与基本注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PathVariable"><span class="toc-number">3.2.2.</span> <span class="toc-text">@PathVariable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestHeader"><span class="toc-number">3.2.3.</span> <span class="toc-text">@RequestHeader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestParam"><span class="toc-number">3.2.4.</span> <span class="toc-text">@RequestParam</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CookieValue"><span class="toc-number">3.2.5.</span> <span class="toc-text">@CookieValue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestBody"><span class="toc-number">3.2.6.</span> <span class="toc-text">@RequestBody</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestAttribute"><span class="toc-number">3.2.7.</span> <span class="toc-text">@RequestAttribute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MatrixVariable"><span class="toc-number">3.2.8.</span> <span class="toc-text">@MatrixVariable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.9.</span> <span class="toc-text">各种参数类型解析原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.2.10.</span> <span class="toc-text">参数处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.2.11.</span> <span class="toc-text">返回值处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.2.12.</span> <span class="toc-text">执行处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E5%80%BC"><span class="toc-number">3.2.12.1.</span> <span class="toc-text">如何确定目标方法每一个参数值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E8%BF%99%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E5%80%BC"><span class="toc-number">3.2.12.2.</span> <span class="toc-text">解析这个参数的值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet-API"><span class="toc-number">3.3.</span> <span class="toc-text">Servlet API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%8F%82%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">复杂参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A%E5%8E%9F%E7%90%86"><span class="toc-number">3.5.</span> <span class="toc-text">自定义类型参数绑定原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POJO-%E5%B0%81%E8%A3%85%E8%BF%87%E7%A8%8B"><span class="toc-number">3.5.1.</span> <span class="toc-text">POJO 封装过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Converter%E5%8E%9F%E7%90%86"><span class="toc-number">3.5.2.</span> <span class="toc-text">自定义Converter原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86"><span class="toc-number">3.6.</span> <span class="toc-text">数据响应与内容协商</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%8D%E5%BA%94JSON"><span class="toc-number">3.6.1.</span> <span class="toc-text">响应JSON</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">返回值解析器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8%E5%8E%9F%E7%90%86%EF%BC%88HttpMssageConverter%EF%BC%89"><span class="toc-number">3.6.2.</span> <span class="toc-text">消息转换器原理（HttpMssageConverter）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MessageConverter-%E8%A7%84%E8%8C%83"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">MessageConverter 规范</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4MessageConverter"><span class="toc-number">3.6.2.2.</span> <span class="toc-text">默认MessageConverter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86"><span class="toc-number">3.6.3.</span> <span class="toc-text">内容协商</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5xml%E4%BE%9D%E8%B5%96"><span class="toc-number">3.6.3.1.</span> <span class="toc-text">引入xml依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%94%E5%9B%9Ejson%E5%92%8Cxml"><span class="toc-number">3.6.3.2.</span> <span class="toc-text">测试返回json和xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86-1"><span class="toc-number">3.6.3.3.</span> <span class="toc-text">内容协商</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8F%82%E6%95%B0%E6%96%B9%E5%BC%8F%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8A%9F%E8%83%BD"><span class="toc-number">3.6.3.4.</span> <span class="toc-text">开启浏览器参数方式内容协商功能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89MessageConverter"><span class="toc-number">3.6.3.5.</span> <span class="toc-text">自定义MessageConverter</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%A4%84%E7%90%86%E7%9A%84MessageConverter"><span class="toc-number">3.6.3.5.1.</span> <span class="toc-text">根据请求头处理的MessageConverter</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E7%9A%84MessageConverter"><span class="toc-number">3.6.3.5.2.</span> <span class="toc-text">根据参数处理的MessageConverter</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.1.</span> <span class="toc-text">定义拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">拦截器原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">5.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">文件上传原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">6.1.</span> <span class="toc-text">定制错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">异常处理自动配置原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">6.3.</span> <span class="toc-text">异常处理流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E5%8E%9F%E7%94%9F%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%85%A5%EF%BC%88Servlet%E3%80%81Filter%E3%80%81Listener%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">Web原生组件注入（Servlet、Filter、Listener）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ServletApi"><span class="toc-number">7.1.</span> <span class="toc-text">使用ServletApi</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WebServlet"><span class="toc-number">7.1.1.</span> <span class="toc-text">@WebServlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebFilter"><span class="toc-number">7.1.2.</span> <span class="toc-text">@WebFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebListener"><span class="toc-number">7.1.3.</span> <span class="toc-text">@WebListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ServletComponentScan"><span class="toc-number">7.1.4.</span> <span class="toc-text">@ServletComponentScan</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RegistrationBean"><span class="toc-number">7.2.</span> <span class="toc-text">使用RegistrationBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">7.3.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8FServlet%E5%AE%B9%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">嵌入式Servlet容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%B5%8C%E5%85%A5%E5%BC%8FServlet%E5%AE%B9%E5%99%A8"><span class="toc-number">8.1.</span> <span class="toc-text">切换嵌入式Servlet容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2servlet%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.2.</span> <span class="toc-text">切换servlet服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">8.3.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6servlet%E5%AE%B9%E5%99%A8"><span class="toc-number">8.4.</span> <span class="toc-text">定制servlet容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%8C%96%E5%8E%9F%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">定制化原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%8C%96%E7%9A%84%E5%B8%B8%E8%A7%81%E6%96%B9%E5%BC%8F"><span class="toc-number">9.1.</span> <span class="toc-text">定制化的常见方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">9.2.</span> <span class="toc-text">原理分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7"><span class="toc-number">10.</span> <span class="toc-text">指标监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot-Actuator"><span class="toc-number">10.1.</span> <span class="toc-text">SpringBoot Actuator</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">10.1.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">10.1.2.</span> <span class="toc-text">可视化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Actuator-Endpoint"><span class="toc-number">10.2.</span> <span class="toc-text">Actuator Endpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Health-Endpoint"><span class="toc-number">10.2.1.</span> <span class="toc-text">Health Endpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Metrics-Endpoint"><span class="toc-number">10.2.2.</span> <span class="toc-text">Metrics Endpoint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86Endpoint"><span class="toc-number">10.3.</span> <span class="toc-text">管理Endpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E4%B8%8E%E7%A6%81%E7%94%A8Endpoint"><span class="toc-number">10.3.1.</span> <span class="toc-text">开启与禁用Endpoint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6Endpoint"><span class="toc-number">10.4.</span> <span class="toc-text">定制Endpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6Health%E4%BF%A1%E6%81%AF"><span class="toc-number">10.4.1.</span> <span class="toc-text">定制Health信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6info%E4%BF%A1%E6%81%AF"><span class="toc-number">10.4.2.</span> <span class="toc-text">定制info信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6Metrics%E4%BF%A1%E6%81%AF"><span class="toc-number">10.4.3.</span> <span class="toc-text">定制Metrics信息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AE%9A%E5%88%B6Metrics"><span class="toc-number">10.4.3.1.</span> <span class="toc-text">增加定制Metrics</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89Endpoint"><span class="toc-number">10.4.4.</span> <span class="toc-text">定义Endpoint</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Spring Boot核心功能 - 学习笔记
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Clover You</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-01-02T10:06:00.000Z" class="dt-published" itemprop="datePublished">2022-01-02</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Spring/">Spring</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/JAVA/" rel="tag">JAVA</a>, <a class="p-category" href="/tags/Spring/" rel="tag">Spring</a>, <a class="p-category" href="/tags/SpringBoot/" rel="tag">SpringBoot</a>, <a class="p-category" href="/tags/SpringMvc/" rel="tag">SpringMvc</a>, <a class="p-category" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h3><h4 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h4><p>与之前使用<code>properties</code>文件的用法一致</p>
<h4 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h4><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>YAML是<code>YAML Ain&#39;t markup Language</code> 的递归缩写。在开发这种语言时，YAML的意思是<code>Yet Another Markup Language</code>。</p>
<p>非常适合用来做以数据为中心的配置文件</p>
<h5 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h5><ul>
<li><code>key: value</code>kv之间有空格</li>
<li>大小写敏感</li>
<li>使用缩进表示层级关系</li>
<li>缩进不允许使用<strong>tab</strong>，只允许空格</li>
<li>缩进的空格数不重要，只要在相同层级的元素左对齐即可</li>
<li><code>#</code>表示注释</li>
<li>字符串无需加引号，如果需要，<code>&#39;&#39;</code>与<code>&quot;&quot;</code>表示字符串内容，会被转义&#x2F;不转义</li>
</ul>
<h5 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h5><ul>
<li><p>字面量：单个的、不可再分的值。date、boolean、string、number、null</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k:</span> <span class="string">v</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>对象：简直对的集合，map、hash、set、object</p>
<ul>
<li><p>行内写法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k:</span> &#123;<span class="attr">k1:</span> <span class="string">v1</span>, <span class="attr">k2:</span> <span class="string">v2</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>普通写法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k:</span> </span><br><span class="line">	<span class="attr">k1:</span> <span class="string">v1</span></span><br><span class="line">	<span class="attr">k2:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>数组： 一组按次序排列的值，array、list、queue</p>
<ul>
<li><p>行内写法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k:</span> [<span class="string">v1</span>, <span class="string">v2</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>普通写法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k:</span> </span><br><span class="line">	<span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><p>使用一个<code>Person</code>组件绑定对应配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7514130876563463491L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] interest;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我习惯了JSON的写法，发现它也支持，那就这样用叭～</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">person:</span> &#123;</span><br><span class="line">    <span class="attr">name:</span> <span class="number">2</span>,</span><br><span class="line">    <span class="attr">age:</span> <span class="number">18</span>,</span><br><span class="line">    <span class="attr">interest:</span> [ <span class="string">女</span> ],</span><br><span class="line">    <span class="attr">map:</span> &#123;</span><br><span class="line">      <span class="attr">map1:</span> <span class="string">value</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查<code>Person</code>容器是否正常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">app</span> <span class="operator">=</span> SpringApplication.run(Example.class, args);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">bean</span> <span class="operator">=</span> app.getBean(Person.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot; _   _     __   __          \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;| | | |_ __\\ \\ / /__  _   _ \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;| | | | &#x27;_ \\\\ V / _ \\| | | |\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;| |_| | |_) || | (_) | |_| |\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \\___/| .__(_)_|\\___/ \\__,_|\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      |_|                   &quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>输出：<code>Person(name=2, interest=[女], age=18, map=&#123;map1=value&#125;)</code></p>
<h3 id="自定义类绑定的配置提示"><a href="#自定义类绑定的配置提示" class="headerlink" title="自定义类绑定的配置提示"></a>自定义类绑定的配置提示</h3><p>有没有发现我们写的配置都没得提示？而且绑定类顶部还有一个提示框消不掉。</p>
<p>需要添加<code>spring-boot-configuration-processor</code>依赖，添加完依赖之后就可以了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个插件其实只是在我们开发的时候有帮助，而在生产环境是无用的，还会让JVM启动时加载无用的依赖导致耗时过长。可以在<code>pom.xml</code>文件中将开发环境下才有效的依赖配置为不参与打包。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">          ...</span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h2><h3 id="简单功能分析"><a href="#简单功能分析" class="headerlink" title="简单功能分析"></a>简单功能分析</h3><h4 id="静态资源访问"><a href="#静态资源访问" class="headerlink" title="静态资源访问"></a>静态资源访问</h4><h5 id="静态资源目录"><a href="#静态资源目录" class="headerlink" title="静态资源目录"></a>静态资源目录</h5><p>SpringBoot的静态资源是在当前项目的类路径下 <code>/static</code> 、 <code>/public</code> 、 <code>/resources</code> 、 <code>/META-INF/resources</code>，如果资源在规定的目录下，SpringBoot可以直接访问到这些目录中的资源文件。</p>
<p>例如我在<code>/resources/static</code>文件夹下有一张图片，使用浏览器请求看看能不能直接访问这张图片</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049118.png" alt="项目结构"></p>
<p>没毛病</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271052434.png" alt="测试结果"></p>
<h5 id="静态资源访问原理"><a href="#静态资源访问原理" class="headerlink" title="静态资源访问原理"></a>静态资源访问原理</h5><p>例如我们有一个请求与静态资源文件的路径一致，那么请求的时候是将静态资源文件返回还是处理对应请求呢：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/back.jpeg&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testResource</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当浏览器访问<code>/back.jpeg</code>的时候，响应了’Hello’字符串。</p>
<p>静态资源映射路径是<code>/**</code>，而请求进来的时候，是先去找<code>Controller</code>看能不能处理这个请求，如果不能则交给静态资源处理器。如果都找不到，则返回<strong>404</strong></p>
<h5 id="静态资源访问前缀"><a href="#静态资源访问前缀" class="headerlink" title="静态资源访问前缀"></a>静态资源访问前缀</h5><p>静态资源访问默认是无前缀的，如果通过拦截器，例如登录拦截器，可能会拦截到静态资源文件，所以我们需要给静态资源指定一个前缀，这样拦截器就可以很方便的将静态资源过滤。</p>
<p>只需要在配置文件中配置<code>spring.mvc.static-path-pattern</code>就可以，默认是<code>/**</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/static/**</span></span><br></pre></td></tr></table></figure>



<h5 id="静态资源路径修改"><a href="#静态资源路径修改" class="headerlink" title="静态资源路径修改"></a>静态资源路径修改</h5><p>SpringBoot默认的静态资源路径是在类路径下，如果不需要使用默认的设置，也可以通过配置文件进行修改，它可以是一个数组，因为静态资源路径他是多个的。 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> <span class="string">classpath:/ctong/</span></span><br></pre></td></tr></table></figure>



<h5 id="欢迎页配置"><a href="#欢迎页配置" class="headerlink" title="欢迎页配置"></a>欢迎页配置</h5><ul>
<li>将<code>index.html</code>文件放在静态资源路径下<ul>
<li>如果配置了静态资源路径前缀，会导致欢迎页的配置无法使用</li>
<li>可以配置静态资源路径</li>
</ul>
</li>
<li>在<code>controller</code>中处理<code>/index</code>请求，他会被当成静态页显示出来。</li>
</ul>
<h5 id="Favicon"><a href="#Favicon" class="headerlink" title="Favicon"></a>Favicon</h5><p>如果需要更换Favicon，则需要将对应的文件放到静态资源目录下，名字必须是<code>favicon.ico</code>，SpringBoot会默认将它设置为网页的icon。</p>
<blockquote>
<p>如果设置了静态资源路径前缀，那么favicon将不会生效。</p>
</blockquote>
<h5 id="静态资源配置原理"><a href="#静态资源配置原理" class="headerlink" title="静态资源配置原理"></a>静态资源配置原理</h5><ul>
<li><p>SpringBoot启动默认加载<code>xxxAutoConfiguration</code>「自动配置类」</p>
</li>
<li><p>SpringMVC功能配置类<code>WebMvcAutoConfiguration</code>，检查该配置类是否生效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DispatcherServletAutoConfiguration.class, TaskExecutionAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">		ValidationAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcAutoConfiguration</span> &#123;...&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给容器配了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Import(EnableWebMvcConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123; WebMvcProperties.class,</span></span><br><span class="line"><span class="meta">		org.springframework.boot.autoconfigure.web.ResourceProperties.class, WebProperties.class &#125;)</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WebMvcAutoConfigurationAdapter</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;...&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件的相关属性和<code>WebMvcProperties</code>、<code>ResourceProperties</code>、<code>WebProperties</code>，进行了绑定</p>
</li>
</ul>
<h6 id="资源处理默认规则核心代码"><a href="#资源处理默认规则核心代码" class="headerlink" title="资源处理默认规则核心代码"></a><strong>资源处理默认规则核心代码</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.addResourceHandlers(registry);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.resourceProperties.isAddMappings()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Default resource handling disabled&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> getServletContext();</span><br><span class="line">  addResourceHandler(registry, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class="line">  addResourceHandler(registry, <span class="built_in">this</span>.mvcProperties.getStaticPathPattern(), (registration) -&gt; &#123;</span><br><span class="line">    registration.addResourceLocations(<span class="built_in">this</span>.resourceProperties.getStaticLocations());</span><br><span class="line">    <span class="keyword">if</span> (servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">      registration.addResourceLocations(<span class="keyword">new</span> <span class="title class_">ServletContextResource</span>(servletContext, SERVLET_LOCATION));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果以下代码为<code>false</code>，那么禁用所有默认规则，一旦禁用，所有静态资源无法访问，它对应了<code>spring.resources.add-mappings</code>配置 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!<span class="built_in">this</span>.resourceProperties.isAddMappings()</span><br></pre></td></tr></table></figure>

<p>以下代码是注册<strong>wenjars</strong>路径的默认规则，只要前缀为<code>/webjars/**</code>那么都去指定目录中找<code>classpath:/META-INF/resources/webjars/</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addResourceHandler(registry, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br></pre></td></tr></table></figure>



<p>这才是我们资源路径的默认规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">addResourceHandler(registry, <span class="built_in">this</span>.mvcProperties.getStaticPathPattern(), (registration) -&gt; &#123;</span><br><span class="line">  registration.addResourceLocations(<span class="built_in">this</span>.resourceProperties.getStaticLocations());</span><br><span class="line">  <span class="keyword">if</span> (servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">    registration.addResourceLocations(<span class="keyword">new</span> <span class="title class_">ServletContextResource</span>(servletContext, SERVLET_LOCATION));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>其实就是获取到配置文件中我们自定义的资源路径前缀<code>/static/**</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.mvcProperties.getStaticPathPattern()</span><br></pre></td></tr></table></figure>

<p>这段代码是获取到配置文件中的资源文件路径<code>classpath:/ctong/</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.resourceProperties.getStaticLocations()</span><br></pre></td></tr></table></figure>

<p>其实就是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addResourceHandler(registry, <span class="string">&quot;/static/**&quot;</span>, <span class="string">&quot;classpath:/resources/ctong/&quot;</span>);</span><br></pre></td></tr></table></figure>





<h6 id="欢迎页的处理规则"><a href="#欢迎页的处理规则" class="headerlink" title="欢迎页的处理规则"></a><strong>欢迎页的处理规则</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title function_">welcomePageHandlerMapping</span><span class="params">(ApplicationContext applicationContext,</span></span><br><span class="line"><span class="params">                                                           FormattingConversionService mvcConversionService, ResourceUrlProvider mvcResourceUrlProvider)</span> &#123;</span><br><span class="line">  <span class="type">WelcomePageHandlerMapping</span> <span class="variable">welcomePageHandlerMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WelcomePageHandlerMapping</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TemplateAvailabilityProviders</span>(applicationContext), applicationContext, getWelcomePage(),</span><br><span class="line">    <span class="built_in">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">  welcomePageHandlerMapping.setInterceptors(getInterceptors(mvcConversionService, mvcResourceUrlProvider));</span><br><span class="line">  welcomePageHandlerMapping.setCorsConfigurations(getCorsConfigurations());</span><br><span class="line">  <span class="keyword">return</span> welcomePageHandlerMapping;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>welcomePage != null &amp;&amp; &quot;/**&quot;.equals(staticPathPattern)</code>解释了我们修改资源路径前缀时为何欢迎页失效的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">WelcomePageHandlerMapping(TemplateAvailabilityProviders templateAvailabilityProviders,</span><br><span class="line">                          ApplicationContext applicationContext, Resource welcomePage, String staticPathPattern) &#123;</span><br><span class="line">  <span class="keyword">if</span> (welcomePage != <span class="literal">null</span> &amp;&amp; <span class="string">&quot;/**&quot;</span>.equals(staticPathPattern)) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Adding welcome page: &quot;</span> + welcomePage);</span><br><span class="line">    setRootViewName(<span class="string">&quot;forward:index.html&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (welcomeTemplateExists(templateAvailabilityProviders, applicationContext)) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Adding welcome page template: index&quot;</span>);</span><br><span class="line">    setRootViewName(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>如果我们看一个配置文件，那么一定要看它是否生效</p>
</li>
<li><p>配置类只有一个有参构造器，有参构造器中所有参数的值都会从容器中确定。</p>
</li>
</ul>
</blockquote>
<h2 id="请求参数处理"><a href="#请求参数处理" class="headerlink" title="请求参数处理"></a>请求参数处理</h2><h3 id="请求映射"><a href="#请求映射" class="headerlink" title="请求映射"></a>请求映射</h3><ul>
<li><code>@xxxMapping</code>，经常使用<code>@RequestMapping</code></li>
<li><code>Rest</code>风格支持「使用HTTP请求方式动词来表示对资源的操作」<ul>
<li>以前<code>/getUser</code>获取用户<code>/deleteUser</code>删除用户，<code>/saveUser</code>保存用户</li>
<li>现在<code>/user</code>GET-获取用户 DELETE-删除用户 PUT-修改用户 POST-保存用户</li>
</ul>
</li>
</ul>
<p>如果需要使用<code>Rest</code>风格的请求，那么必须发起<code>POST</code>,并且携带一个隐藏参数<code>_method</code>，这个参数值为<code>PUT</code>、<code>DELETE</code>。</p>
<p>当你测试发起<code>Rest</code>风格请求时，发现并没有效果。查看检查映射处理源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;, matchIfMissing = false)</span></span><br><span class="line"><span class="keyword">public</span> OrderedHiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedHiddenHttpMethodFilter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</code>很显然我们并没有配置，所以这个是生效的。</p>
<p><code>@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;, matchIfMissing = false)</code>，<code>enabled</code>翻译为启用的意思，<code>matchIfMissing</code>为<code>false</code>，所以我们请求没生效的原因是<code>Rest</code>请求被禁用了。</p>
<h4 id="Rest原理"><a href="#Rest原理" class="headerlink" title="Rest原理"></a>Rest原理</h4><p>直接上源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">  <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">HttpServletRequest</span> <span class="variable">requestToUse</span> <span class="operator">=</span> request;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span>.equals(request.getMethod()) &amp;&amp; request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.methodParam);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(paramValue)) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> paramValue.toUpperCase(Locale.ENGLISH);</span><br><span class="line">      <span class="keyword">if</span> (ALLOWED_METHODS.contains(method)) &#123;</span><br><span class="line">        requestToUse = <span class="keyword">new</span> <span class="title class_">HttpMethodRequestWrapper</span>(request, method);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  filterChain.doFilter(requestToUse, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查当前请求参数是否为<code>POST</code>，并且当前请求是否存在错误</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span>.equals(request.getMethod()) &amp;&amp; request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) == <span class="literal">null</span>) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>获取指定参数，<code>this.methodParam</code>其实就是<code>_method</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.methodParam);</span><br></pre></td></tr></table></figure>

<p>检查该参数是否不为空</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (StringUtils.hasLength(paramValue)) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>无论是小写还是大些，全部转为大些</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> paramValue.toUpperCase(Locale.ENGLISH);</span><br></pre></td></tr></table></figure>

<p>检查是否兼容当前请求方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ALLOWED_METHODS.contains(method)) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; ALLOWED_METHODS =</span><br><span class="line">      Collections.unmodifiableList(Arrays.asList(HttpMethod.PUT.name(),</span><br><span class="line">            HttpMethod.DELETE.name(), HttpMethod.PATCH.name()));</span><br></pre></td></tr></table></figure>

<p>这里重新包装了一下<code>HttpServletRequest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requestToUse = <span class="keyword">new</span> <span class="title class_">HttpMethodRequestWrapper</span>(request, method);</span><br></pre></td></tr></table></figure>

<p>因为它是以<code>POST</code>的方式请求进来的，所以<code>HttpServletReqest</code>提供的<code>getMethod</code>方法获取的是一个<code>POST</code>而不是对应的<code>PUT</code>、<code>DELETE</code>，所以需要重新将<code>method</code>改成对应的请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HttpMethodRequestWrapper</span> <span class="keyword">extends</span> <span class="title class_">HttpServletRequestWrapper</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String method;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">HttpMethodRequestWrapper</span><span class="params">(HttpServletRequest request, String method)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(request);</span><br><span class="line">    <span class="built_in">this</span>.method = method;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.method;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后放行了过滤器链<code>wrapper</code>，以后我们开发使用<code>Rest</code>风格请求时，<code>HttpServletRequest</code>其实是<code>SpringBoot</code>给我们包装的。</p>
<p><code>filterChain.doFilter(requestToUse, response);</code></p>
<h4 id="请求映射原理"><a href="#请求映射原理" class="headerlink" title="请求映射原理"></a>请求映射原理</h4><p>SpringBoot处理请求是在<code>DispatcherServlet</code> <code>FrameworkServlet</code> <code>HttpServlet</code></p>
<p>在<code>processRequest</code>方法中处理请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process this request, publishing an event regardless of the outcome.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The actual event handling is performed by the abstract</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> #doService&#125; template method.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">  <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">  <span class="type">Throwable</span> <span class="variable">failureCause</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">LocaleContext</span> <span class="variable">previousLocaleContext</span> <span class="operator">=</span> LocaleContextHolder.getLocaleContext();</span><br><span class="line">  <span class="type">LocaleContext</span> <span class="variable">localeContext</span> <span class="operator">=</span> buildLocaleContext(request);</span><br><span class="line"></span><br><span class="line">  <span class="type">RequestAttributes</span> <span class="variable">previousAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">  <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> buildRequestAttributes(request, response, previousAttributes);</span><br><span class="line"></span><br><span class="line">  <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">  asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), <span class="keyword">new</span> <span class="title class_">RequestBindingInterceptor</span>());</span><br><span class="line"></span><br><span class="line">  initContextHolders(request, localeContext, requestAttributes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    doService(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ServletException | IOException ex) &#123;</span><br><span class="line">    failureCause = ex;</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    failureCause = ex;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Request processing failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    resetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class="line">    <span class="keyword">if</span> (requestAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">      requestAttributes.requestCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">    logResult(request, response, failureCause, asyncManager);</span><br><span class="line">    publishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>try</code>中又调用了<code>doService</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class="doctag">@link</span> #doDispatch&#125;</span></span><br><span class="line"><span class="comment">	 * for the actual dispatching.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  logRequest(request);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class="line">  <span class="comment">// to be able to restore the original attributes after the include.</span></span><br><span class="line">  Map&lt;String, Object&gt; attributesSnapshot = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">    attributesSnapshot = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">    <span class="keyword">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> (String) attrNames.nextElement();</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.cleanupAfterInclude || attrName.startsWith(DEFAULT_STRATEGIES_PREFIX)) &#123;</span><br><span class="line">        attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make framework objects available to handlers and view objects.</span></span><br><span class="line">  request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">  request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="built_in">this</span>.localeResolver);</span><br><span class="line">  request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="built_in">this</span>.themeResolver);</span><br><span class="line">  request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.flashMapManager != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">FlashMap</span> <span class="variable">inputFlashMap</span> <span class="operator">=</span> <span class="built_in">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">    <span class="keyword">if</span> (inputFlashMap != <span class="literal">null</span>) &#123;</span><br><span class="line">      request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">    &#125;</span><br><span class="line">    request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="keyword">new</span> <span class="title class_">FlashMap</span>());</span><br><span class="line">    request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="built_in">this</span>.flashMapManager);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">RequestPath</span> <span class="variable">previousRequestPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.parseRequestPath) &#123;</span><br><span class="line">    previousRequestPath = (RequestPath) request.getAttribute(ServletRequestPathUtils.PATH_ATTRIBUTE);</span><br><span class="line">    ServletRequestPathUtils.parseAndCache(request);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    doDispatch(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">      <span class="comment">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class="line">      <span class="keyword">if</span> (attributesSnapshot != <span class="literal">null</span>) &#123;</span><br><span class="line">        restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ServletRequestPathUtils.setParsedRequestPath(previousRequestPath, request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个方法中又有一个<code>doDispatch</code>方法，这个才是最核心的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process the actual dispatching to the handler.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The handler will be obtained by applying the servlet&#x27;s HandlerMappings in order.</span></span><br><span class="line"><span class="comment">	 * The HandlerAdapter will be obtained by querying the servlet&#x27;s installed HandlerAdapters</span></span><br><span class="line"><span class="comment">	 * to find the first that supports the handler class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;All HTTP methods are handled by this method. It&#x27;s up to HandlerAdapters or handlers</span></span><br><span class="line"><span class="comment">	 * themselves to decide which methods are acceptable.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">  <span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      processedRequest = checkMultipart(request);</span><br><span class="line">      multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Determine handler for the current request.</span></span><br><span class="line">      mappedHandler = getHandler(processedRequest);</span><br><span class="line">      <span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">        noHandlerFound(processedRequest, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">      <span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> <span class="string">&quot;GET&quot;</span>.equals(method);</span><br><span class="line">      <span class="keyword">if</span> (isGet || <span class="string">&quot;HEAD&quot;</span>.equals(method)) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Actually invoke the handler.</span></span><br><span class="line">      mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      applyDefaultViewName(processedRequest, mv);</span><br><span class="line">      mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      dispatchException = ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">      <span class="comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span></span><br><span class="line">      <span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">      dispatchException = <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">    processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">    triggerAfterCompletion(processedRequest, response, mappedHandler,</span><br><span class="line">                           <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler processing failed&quot;</span>, err));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">      <span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">      <span class="keyword">if</span> (mappedHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">        mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">      <span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">        cleanupMultipart(processedRequest);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>org.springframework.web.servlet.DispatcherServlet -&gt; doDispatch()</p>
</blockquote>
<p>查找哪个<code>Controller</code>能处理当前请求，<code>com.upyou.hall.controller.HelloController#saveUser()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mappedHandler = getHandler(processedRequest);</span><br></pre></td></tr></table></figure>

<p>进到这个方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">      <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">      <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现有一个<code>this.handlerMappings</code>，这个属性保存的是请求的映射规则。其中<code>RequestMappingHandlerMapping</code> 就保存了所有<code>@RequestMapping</code>和<code>handler</code>的映射规则。<img src="http://qiniu-note-image.ctong.top/note/images/202112271049137.png" alt="handlerMapping"></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049148.png" alt="所有请求路径"></p>
<p>进入<code>mapping.getHandler(request);</code> -&gt;&gt; <code>getHandlerInternal(request);</code> -&gt;&gt; <code>super.getHandlerInternal(request);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Look up a handler method for the given request.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> initLookupPath(request);</span><br><span class="line">  <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">    <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿到当前请求的路径<code>/user</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> initLookupPath(request);</span><br></pre></td></tr></table></figure>

<p>防止并发请求查询<code>mappingRegistry</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br></pre></td></tr></table></figure>

<p>进入<code>HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  List&lt;Match&gt; matches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br><span class="line">  <span class="keyword">if</span> (directPathMatches != <span class="literal">null</span>) &#123;</span><br><span class="line">    addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">    addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getRegistrations().keySet(), matches, request);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">    <span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> <span class="title class_">MatchComparator</span>(getMappingComparator(request));</span><br><span class="line">      matches.sort(comparator);</span><br><span class="line">      bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Match match : matches) &#123;</span><br><span class="line">          <span class="keyword">if</span> (match.hasCorsConfig()) &#123;</span><br><span class="line">            <span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Match</span> <span class="variable">secondBestMatch</span> <span class="operator">=</span> matches.get(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> bestMatch.getHandlerMethod().getMethod();</span><br><span class="line">          <span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> secondBestMatch.getHandlerMethod().getMethod();</span><br><span class="line">          <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">            <span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.getHandlerMethod());</span><br><span class="line">    handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">    <span class="keyword">return</span> bestMatch.getHandlerMethod();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> handleNoMatch(<span class="built_in">this</span>.mappingRegistry.getRegistrations().keySet(), lookupPath, request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>lookupPath</code>在<code>mappingRegistry</code>中找能够处理这个路径的<code>handler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br></pre></td></tr></table></figure>

<p>发现它找到了两个，同路径但不同的请求类型</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049142.png" alt="mappingRegistry查询结果"></p>
<p>其实就是通过请求方式和路径参数在<code>RequestMapping</code>中找到对应的<code>Mapping</code>添加到<code>matches</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addMatchingMappings(directPathMatches, matches, request);</span><br></pre></td></tr></table></figure>

<p>如果无法在<code>RequestMapping</code>中找到，再通过请求方式和路径参数找所有HandlerMapping，如果找到则将其添加到<code>matches</code>中，这所有包括了资源路径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getRegistrations().keySet(), matches, request);</span><br></pre></td></tr></table></figure>

<p>拿到第一个<code>Mapping</code>,因为这极有可能是最适合处理当前请求的<code>Mapping</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>当匹配到多个结果之后，检查是不是同个请求方式、路径注册了两个处理器，如果是则抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;...&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>SpringBoot默认配置了<code>RequestMappingHandlerMapping</code></li>
</ul>
<h3 id="普通参数与基本注解"><a href="#普通参数与基本注解" class="headerlink" title="普通参数与基本注解"></a>普通参数与基本注解</h3><h4 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h4><p>  <code>@PathVariable</code> <code>@RequestHeader</code> <code>@ModelAttribute</code> <code>@RequestParam</code> <code>@MatrixVariable</code> <code>@CookieValue</code> <code>@RequestBody</code></p>
<h4 id="PathVariable"><a href="#PathVariable" class="headerlink" title="@PathVariable"></a>@PathVariable</h4><p>获取动态径上的数据<br>  <code>@RequestParam(&quot;id&quot;)、@RequestParam(&quot;token&quot;)</code>分别是获取 <code>&#123;id&#125;</code> <code>&#123;token&#125;</code>位置的值，也就是说他们是动态的，</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/index/&#123;id&#125;/get/&#123;token&#125;/info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">handleHallo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> String id,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@PathVariable(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">  Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">  map.put(<span class="string">&quot;map&quot;</span>, id);</span><br><span class="line">  map.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">  <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  请求<code>localhost:8888/index/1024/get/2048/info</code></p>
<p>  结果</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;map&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1024&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2048&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="RequestHeader"><a href="#RequestHeader" class="headerlink" title="@RequestHeader"></a>@RequestHeader</h4><p>获取指定请求头</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleHallo</span><span class="params">(<span class="meta">@RequestHeader(&quot;User-Agent&quot;)</span> String userAgent)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> userAgent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  输出<code>PostmanRuntime/7.26.10</code></p>
<p>  如果被标注的类型为<code>java.util.Map、org.springframework.util.MultiValueMap、org.springframework.http.HttpHeaders</code>那么SpringBoot可以给你拿到所有的请求头</p>
<h4 id="RequestParam"><a href="#RequestParam" class="headerlink" title="@RequestParam"></a>@RequestParam</h4><p>获取请求参数</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleHallo</span><span class="params">(<span class="meta">@RequestParam(&quot;userName&quot;)</span> String userName)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  请求<code>localhost:8888/index?userName=UpYou</code></p>
<p>  输出：<strong>UpYou</strong></p>
<p>  如果<code>@RequestParam</code>没有指定获取那个参数，并且被标注的类型为<code>Map&lt;String, String&gt;</code>，该变量将拿到所有的请求参数</p>
<h4 id="CookieValue"><a href="#CookieValue" class="headerlink" title="@CookieValue"></a>@CookieValue</h4><p>获取<code>cookie</code><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleHallo</span><span class="params">(<span class="meta">@CookieValue(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  如果被标注的类型是<code>Cookie</code>，那么它将获取指定cookie的所有信息</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CookieValue(&quot;token&quot;)</span> Cookie token</span><br></pre></td></tr></table></figure>

<h4 id="RequestBody"><a href="#RequestBody" class="headerlink" title="@RequestBody"></a>@RequestBody</h4><p>获取球体「POST」</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleHallo</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UpYou&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="RequestAttribute"><a href="#RequestAttribute" class="headerlink" title="@RequestAttribute"></a>@RequestAttribute</h4><p>获取到当前请求的域对象中的指定属性</p>
<p>  做一个请求，在这个请求中设置域对象的属性，然后转发到<code>/success</code>请求中处理</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8638687587976398521L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">HelloController</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">handleHallo</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;UpYou&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/success&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">toDo</span><span class="params">(<span class="meta">@RequestAttribute(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>  输出结果<code>UpYou</code></p>
<h4 id="MatrixVariable"><a href="#MatrixVariable" class="headerlink" title="@MatrixVariable"></a>@MatrixVariable</h4><p>矩阵变量，它绑定在路径变量中。<br>  <code>/xxx/&#123;path&#125;?xxx=xxx&amp;xxx=xxx</code>这个叫做查询字符串，可以使用<code>@RequestParam</code>获取</p>
<p>  <code>/xxx/&#123;path;low=34;brand=byd,audi,yd&#125;</code>这个是矩阵变量</p>
<blockquote>
<p>例如前端cookie被禁用了，session里面的内容怎么使用 ，这时候可以使用矩阵变量进行传递：<code>/xxx;jsessionid=xxx</code></p>
</blockquote>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get/sell&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">index</span><span class="params">(<span class="meta">@MatrixVariable(&quot;age&quot;)</span> Integer age,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@MatrixVariable(&quot;name&quot;)</span> List&lt;String&gt; name)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>, age);</span><br><span class="line">    map.put(<span class="string">&quot;brand&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  请求<code>/get/sell;age=18;name=UpYou,ctong</code></p>
<p>  报错了，原因是SpringBoot默认禁用了矩阵变量，需要手动开启。</p>
<p>  这种情况下需要定制化开启，SpringBoot提供了两种方式</p>
<p>  <strong>第一种</strong><br>  声明<code>WebMvcConfigurer</code>改变默认底层组件</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span></span><br><span class="line">  <span class="keyword">implements</span> <span class="title class_">Serializable</span>, WebMvcConfigurer &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3281050128601582429L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebConfig</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启矩阵变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configurer 路径匹配规则配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> &#123;</span><br><span class="line">    <span class="type">UrlPathHelper</span> <span class="variable">urlPathHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlPathHelper</span>();</span><br><span class="line">    <span class="comment">// 设置不移除分号后边的内容</span></span><br><span class="line">    urlPathHelper.setRemoveSemicolonContent(<span class="literal">false</span>);</span><br><span class="line">    configurer.setUrlPathHelper(urlPathHelper);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>第二种</strong></p>
<p>  组册<code>WebMvcConfigurer</code>类型的组件</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> &#123;</span><br><span class="line">      <span class="type">UrlPathHelper</span> <span class="variable">urlPathHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlPathHelper</span>();</span><br><span class="line">      urlPathHelper.setRemoveSemicolonContent(<span class="literal">false</span>);</span><br><span class="line">      configurer.setUrlPathHelper(urlPathHelper);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>  开启矩阵变量之后，重新请求发现变成了404，原因是<code>@GetMapping(&quot;/get/sell&quot;)</code><strong>不能直接写sell</strong>，需要写成路径变量的形式。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get/&#123;path&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">matrix</span><span class="params">(<span class="meta">@MatrixVariable(&quot;age&quot;)</span> Integer age,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@MatrixVariable(&quot;name&quot;)</span> List&lt;String&gt; name,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@PathVariable(&quot;path&quot;)</span> String path)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>, age);</span><br><span class="line">    map.put(<span class="string">&quot;brand&quot;</span>, name);</span><br><span class="line">    map.put(<span class="string">&quot;path&quot;</span>, path);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  输出<code>&#123;&quot;brand&quot;:[&quot;UpYou&quot;,&quot;ctong&quot;],&quot;path&quot;:&quot;sell&quot;,&quot;age&quot;:18&#125;</code></p>
<p>  如果你遇到了这种路径：<code>/get/1;age=18/2;age=18</code>一个路径中有多个相同矩阵变量。这时候需要使用<code>@MatrixVariable</code>提供的<code>pathVar</code>参数指定路径</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get/&#123;path&#125;/&#123;boss&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">matrixTwo</span><span class="params">(<span class="meta">@PathVariable(&quot;path&quot;)</span> String path,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@PathVariable(&quot;boss&quot;)</span> String boss,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@MatrixVariable(value = &quot;age&quot;, pathVar = &quot;path&quot;)</span> Integer pathAge,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@MatrixVariable(value = &quot;age&quot;, pathVar = &quot;boss&quot;)</span> Integer bossAge)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">    map.put(<span class="string">&quot;pathAge&quot;</span>, pathAge);</span><br><span class="line">    map.put(<span class="string">&quot;bossAge&quot;</span>, bossAge);</span><br><span class="line">    map.put(<span class="string">&quot;path&quot;</span>, path);</span><br><span class="line">    map.put(<span class="string">&quot;boss&quot;</span>, boss);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  输出： <code>&#123;&quot;pathAge&quot;:18,&quot;path&quot;:&quot;path&quot;,&quot;boss&quot;:&quot;boss&quot;,&quot;bossAge&quot;:48&#125;</code></p>
<h4 id="各种参数类型解析原理"><a href="#各种参数类型解析原理" class="headerlink" title="各种参数类型解析原理"></a>各种参数类型解析原理</h4><blockquote>
<p>如果需要查看路径请求处理原理，可以到<code> org.springframework.web.servlet.DispatcherServlet</code>下查看，这是处理请求的入口</p>
</blockquote>
<p>走到<code>DispatcherServlet</code>&#x3D;&#x3D;&gt; <code>doDispatch</code> </p>
<p>找到能处理该请求的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mappedHandler = getHandler(processedRequest);</span><br></pre></td></tr></table></figure>

<p>由于SpringBoot底层需要使用反射机制去调用这个方法，而方法中有各种各样的注解、请求参数，例如<code>PathVariable</code>，<code>@RequestParam</code>等，由于该步骤非常麻烦，所以需要为当前Handler找一个适配器<code>HandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br></pre></td></tr></table></figure>

<p>在getHandlerAdapter方法中，SpringBoot默认为我们提供了四种适配器。分别用来完成不同的功能。</p>
<ol>
<li>支持<code>@RequestMapping</code></li>
<li>支持函数式编程</li>
</ol>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049154.png" alt="适配器"></p>
<p>匹配支持的<code>Handler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (HandlerAdapter adapter : <span class="built_in">this</span>.handlerAdapters) &#123;</span><br><span class="line">   <span class="keyword">if</span> (adapter.supports(handler)) &#123;</span><br><span class="line">      <span class="keyword">return</span> adapter;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后通过适配器去处理这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br></pre></td></tr></table></figure>

<h4 id="参数处理器"><a href="#参数处理器" class="headerlink" title="参数处理器"></a>参数处理器</h4><p>进入<code>ha.handle</code>，这一段，执行目标方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mav = invokeHandlerMethod(request, response, handlerMethod);</span><br></pre></td></tr></table></figure>

<p>再进入<code>invokeHandlerMethod</code> </p>
<p>这是一个参数解析器，将来目标参数值是什么，全都是由这些参数解析器来决定，例如参数标注了<code>@RequestParam</code>，那么就使用图中第一个解析器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.argumentResolvers != <span class="literal">null</span>)&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBootMVC目标方法能写多少种参数类型，全部取决于参数解析器。</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049158.png" alt="参数解析器"></p>
<p><code>supportsParameter</code>检查是否支持解析这种参数，如果支持就调用<code>resolveArgument</code>进行解析处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">         NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="返回值处理器"><a href="#返回值处理器" class="headerlink" title="返回值处理器"></a>返回值处理器</h4><p>这是得到返回值支持的处理器，也就是说，SpringBoot会工具反射去调用对应的方法，这会得到一个返回值，那么会通过这个返回值进行处理，处理完之后返回给客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>) &#123;</span><br><span class="line">  invocableMethod.setHandlerMethodReturnValueHandlers(<span class="built_in">this</span>.returnValueHandlers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="执行处理器"><a href="#执行处理器" class="headerlink" title="执行处理器"></a>执行处理器</h4><p>在这开始执行对应的方法，可以在我们目标方法与<code>invokeAndHandle</code>方法中打一个断点，当<code>invokeAndHandle</code>执行放行之后开始执行目标方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br></pre></td></tr></table></figure>

<p>进到<code>invokeAndHandle</code>，在这才是真正的执行，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br></pre></td></tr></table></figure>

<p>进<code>invokeForRequest</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeForRequest</span><span class="params">(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                               Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Arguments: &quot;</span> + Arrays.toString(args));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> doInvoke(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取方法所有参数的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049358.png" alt="方法所有参数值"></p>
<h5 id="如何确定目标方法每一个参数值"><a href="#如何确定目标方法每一个参数值" class="headerlink" title="如何确定目标方法每一个参数值"></a>如何确定目标方法每一个参数值</h5><p><code>org.springframework.web.method.support.InvocableHandlerMethod</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span><br><span class="line">                                           Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  MethodParameter[] parameters = getMethodParameters();</span><br><span class="line">  <span class="keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;</span><br><span class="line">    <span class="keyword">return</span> EMPTY_ARGS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[parameters.length];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">    <span class="type">MethodParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> parameters[i];</span><br><span class="line">    parameter.initParameterNameDiscovery(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line">    args[i] = findProvidedArgument(parameter, providedArgs);</span><br><span class="line">    <span class="keyword">if</span> (args[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.resolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(formatArgumentError(parameter, <span class="string">&quot;No suitable resolver&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      args[i] = <span class="built_in">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="built_in">this</span>.dataBinderFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      <span class="comment">// Leave stack trace for later, exception may actually be resolved and handled...</span></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exMsg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (exMsg != <span class="literal">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;</span><br><span class="line">          logger.debug(formatArgumentError(parameter, exMsg));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取到所有参数的详细信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MethodParameter[] parameters = getMethodParameters();</span><br></pre></td></tr></table></figure>

<p>查找是否有解析器支持解析当前这种类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">this</span>.resolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(formatArgumentError(parameter, <span class="string">&quot;No suitable resolver&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>supportsParameter</code> &#x3D;&#x3D;&gt; <code>getArgumentResolver</code></p>
<p>判断方式是通过<code>for</code>循环来进行逐个对比得到结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HandlerMethodArgumentResolver <span class="title function_">getArgumentResolver</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">   <span class="type">HandlerMethodArgumentResolver</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.argumentResolverCache.get(parameter);</span><br><span class="line">   <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (HandlerMethodArgumentResolver resolver : <span class="built_in">this</span>.argumentResolvers) &#123;</span><br><span class="line">         <span class="keyword">if</span> (resolver.supportsParameter(parameter)) &#123;</span><br><span class="line">            result = resolver;</span><br><span class="line">            <span class="built_in">this</span>.argumentResolverCache.put(parameter, result);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="解析这个参数的值"><a href="#解析这个参数的值" class="headerlink" title="解析这个参数的值"></a>解析这个参数的值</h5><p>通过得到的解析器来解析这个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">args[i] = <span class="built_in">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="built_in">this</span>.dataBinderFactory);</span><br></pre></td></tr></table></figure>

<p>进入<code>resolveArgument</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                              NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">HandlerMethodArgumentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getArgumentResolver(parameter);</span><br><span class="line">  <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported parameter type [&quot;</span> +</span><br><span class="line">                                       parameter.getParameterType().getName() + <span class="string">&quot;]. supportsParameter should be called first.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取参数解析器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HandlerMethodArgumentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getArgumentResolver(parameter);</span><br></pre></td></tr></table></figure>

<p>使用了<code>resolver.resolveArgument</code>进行解析</p>
<p>进入<code>resolveArgument</code></p>
<p>拿到当前参数的基本信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NamedValueInfo</span> <span class="variable">namedValueInfo</span> <span class="operator">=</span> getNamedValueInfo(parameter);</span><br><span class="line"><span class="type">MethodParameter</span> <span class="variable">nestedParameter</span> <span class="operator">=</span> parameter.nestedIfOptional();</span><br></pre></td></tr></table></figure>

<p>通过对应的解析器获取对应值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">arg</span> <span class="operator">=</span> resolveName(resolvedName.toString(), nestedParameter, webRequest);</span><br></pre></td></tr></table></figure>

<p>进入<code>resolveName</code></p>
<blockquote>
<p>注意，这是一个<code>PathVariableMethodArgumentResolver</code>解析器，其它解析器基本也是这种操作</p>
</blockquote>
<p>由于之前已经将请求参数放进请求域中，所以这里直接从请求域中拿了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">resolveName</span><span class="params">(String name, MethodParameter parameter, NativeWebRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  Map&lt;String, String&gt; uriTemplateVars = (Map&lt;String, String&gt;) request.getAttribute(</span><br><span class="line">    HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">  <span class="keyword">return</span> (uriTemplateVars != <span class="literal">null</span> ? uriTemplateVars.get(name) : <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后将设置好的值全部返回，执行<code>Handler</code></p>
<h3 id="Servlet-API"><a href="#Servlet-API" class="headerlink" title="Servlet API"></a>Servlet API</h3><p>WebRequest、ServletRequest、MultipartRequest、HttpSession、javax.servlet.http.PushBuilder、Principal、InputStream、Reader、HttpMethod、Locale、TimeZone、Zoneld</p>
<blockquote>
<p><code>ServletRequestMethodArgumentResolve</code>解析器支持解析以上大部分参数</p>
</blockquote>
<h3 id="复杂参数"><a href="#复杂参数" class="headerlink" title="复杂参数"></a>复杂参数</h3><p>Map、Model、Errors&#x2F;BindingResult、RedirectAttributes、ServletResponse、SessionStatus、UriComponentsBuilder、ServletUriComponentsBuilder</p>
<ul>
<li><p>如果给<code>Map、Model</code>放数据，会被默认存放在<code>request</code>请求域中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.setAttribute();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/params&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">params</span><span class="params">(Map&lt;String, Object&gt; map,</span></span><br><span class="line"><span class="params">                     Model model,</span></span><br><span class="line"><span class="params">                     HttpServletRequest request,</span></span><br><span class="line"><span class="params">                     HttpServletResponse response)</span> &#123;</span><br><span class="line">  map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;UpYou&quot;</span>);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/success&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">success</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">  <span class="type">Object</span> <span class="variable">name</span> <span class="operator">=</span> request.getAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">  <span class="type">Object</span> <span class="variable">age</span> <span class="operator">=</span> request.getAttribute(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">  HashMap&lt;String, Object&gt; stringObjectHashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  stringObjectHashMap.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">  stringObjectHashMap.put(<span class="string">&quot;age&quot;</span>, age);</span><br><span class="line">  <span class="keyword">return</span> stringObjectHashMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出<code>&#123;&quot;name&quot;:&quot;UpYou&quot;,&quot;age&quot;:18&#125;</code></p>
<blockquote>
<p>Map类型的参数使用MapMethodProcessor解析器解析。这将会返回mavContainer.getModel() &#x3D;&#x3D;&gt;&gt; BindingAwareModelMap，它既是Model也是Map</p>
<p>Model类型与Map类型的处理都是一致的，最终调用的都是mavContainer.getModel()</p>
</blockquote>
</li>
<li><p><code>RedirectAttributes</code>重定向携带的数据</p>
</li>
</ul>
<h3 id="自定义类型参数绑定原理"><a href="#自定义类型参数绑定原理" class="headerlink" title="自定义类型参数绑定原理"></a>自定义类型参数绑定原理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据绑定：页面提交的请求数据（GET、POST、PUT、DELETE）都可以和对象属性进行绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> person 请求数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 请求数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Person <span class="title function_">saveUser</span><span class="params">(Person person)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> person;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7514130876563463491L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String[] interest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Pet pet;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">2248757905577331865L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Pet</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Pet</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049496.png" alt="请求结果"></p>
<h4 id="POJO-封装过程"><a href="#POJO-封装过程" class="headerlink" title="POJO 封装过程"></a>POJO 封装过程</h4><p>自定义类型参数是通过<code>ServletModelAttributeMethodProcessor</code>参数解析器来进行解析的。</p>
<p>判断方式：判断当前类型是否为简单类型，如果不是，则支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (parameter.hasParameterAnnotation(ModelAttribute.class) ||</span><br><span class="line">          (<span class="built_in">this</span>.annotationNotRequired &amp;&amp; !BeanUtils.isSimpleProperty(parameter.getParameterType())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSimpleProperty</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">  Assert.notNull(type, <span class="string">&quot;&#x27;type&#x27; must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> isSimpleValueType(type) || type.isArray() &amp;&amp; isSimpleValueType(type.getComponentType());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSimpleValueType</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Void.class != type &amp;&amp; Void.TYPE != type &amp;&amp; (ClassUtils.isPrimitiveOrWrapper(type) || Enum.class.isAssignableFrom(type) || CharSequence.class.isAssignableFrom(type) || Number.class.isAssignableFrom(type) || Date.class.isAssignableFrom(type) || Temporal.class.isAssignableFrom(type) || URI.class == type || URL.class == type || Locale.class == type || Class.class == type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析器调用<code>resolveArgument</code>方法对这个参数进行解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                                    NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  Assert.state(mavContainer != <span class="literal">null</span>, <span class="string">&quot;ModelAttributeMethodProcessor requires ModelAndViewContainer&quot;</span>);</span><br><span class="line">  Assert.state(binderFactory != <span class="literal">null</span>, <span class="string">&quot;ModelAttributeMethodProcessor requires WebDataBinderFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> ModelFactory.getNameForParameter(parameter);</span><br><span class="line">  <span class="type">ModelAttribute</span> <span class="variable">ann</span> <span class="operator">=</span> parameter.getParameterAnnotation(ModelAttribute.class);</span><br><span class="line">  <span class="keyword">if</span> (ann != <span class="literal">null</span>) &#123;</span><br><span class="line">    mavContainer.setBinding(name, ann.binding());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">Object</span> <span class="variable">attribute</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mavContainer.containsAttribute(name)) &#123;</span><br><span class="line">    attribute = mavContainer.getModel().get(name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Create attribute instance</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      attribute = createAttribute(name, parameter, binderFactory, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BindException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isBindExceptionRequired(parameter)) &#123;</span><br><span class="line">        <span class="comment">// No BindingResult parameter -&gt; fail with BindException</span></span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Otherwise, expose null/empty value and associated BindingResult</span></span><br><span class="line">      <span class="keyword">if</span> (parameter.getParameterType() == Optional.class) &#123;</span><br><span class="line">        attribute = Optional.empty();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        attribute = ex.getTarget();</span><br><span class="line">      &#125;</span><br><span class="line">      bindingResult = ex.getBindingResult();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bindingResult == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Bean property binding and validation;</span></span><br><span class="line">    <span class="comment">// skipped in case of binding failure on construction.</span></span><br><span class="line">    <span class="type">WebDataBinder</span> <span class="variable">binder</span> <span class="operator">=</span> binderFactory.createBinder(webRequest, attribute, name);</span><br><span class="line">    <span class="keyword">if</span> (binder.getTarget() != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!mavContainer.isBindingDisabled(name)) &#123;</span><br><span class="line">        bindRequestParameters(binder, webRequest);</span><br><span class="line">      &#125;</span><br><span class="line">      validateIfApplicable(binder, parameter);</span><br><span class="line">      <span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindException</span>(binder.getBindingResult());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Value type adaptation, also covering java.util.Optional</span></span><br><span class="line">    <span class="keyword">if</span> (!parameter.getParameterType().isInstance(attribute)) &#123;</span><br><span class="line">      attribute = binder.convertIfNecessary(binder.getTarget(), parameter.getParameterType(), parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    bindingResult = binder.getBindingResult();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add resolved attribute and BindingResult at the end of the model</span></span><br><span class="line">  Map&lt;String, Object&gt; bindingResultModel = bindingResult.getModel();</span><br><span class="line">  mavContainer.removeAttributes(bindingResultModel);</span><br><span class="line">  mavContainer.addAllAttributes(bindingResultModel);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> attribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果当前<code>request</code>容器中存在这个属性，则从容器中获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">attribute</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mavContainer.containsAttribute(name)) &#123;</span><br><span class="line">  attribute = mavContainer.getModel().get(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>否则就将这个对象<code>new</code>出来<code>Person</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attribute = createAttribute(name, parameter, binderFactory, webRequest);</span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049672.png" alt="截屏2021-04-02 00.43.17"></p>
<p><code>WebDataBinder</code>是一个web数据绑定组件，将请求参数的值绑定到指定的<code>JavaBean</code>中，指定的<code>JavaBean</code>就是<code>attribute</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebDataBinder</span> <span class="variable">binder</span> <span class="operator">=</span> binderFactory.createBinder(webRequest, attribute, name);</span><br></pre></td></tr></table></figure>

<p><code>WebDataBinder</code>利用它里面的<code>converters</code>将请求数据转换成指定的数据类型，再次封装到<code>JavaBean</code></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049686.png" alt="WebDataBinder结果"></p>
<p>将请求中的数据映射到<code>binder</code>中的<code>target</code>，也就是<code>attribute</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mavContainer.isBindingDisabled(name)) &#123;</span><br><span class="line">   bindRequestParameters(binder, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049036.png" alt="数据映射到attribute"></p>
<p>映射值的源码在<code>org.springframework.beans.AbstractPropertyAccessor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPropertyValues</span><span class="params">(PropertyValues pvs, <span class="type">boolean</span> ignoreUnknown, <span class="type">boolean</span> ignoreInvalid)</span></span><br><span class="line">  <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">  List&lt;PropertyAccessException&gt; propertyAccessExceptions = <span class="literal">null</span>;</span><br><span class="line">  List&lt;PropertyValue&gt; propertyValues = (pvs <span class="keyword">instanceof</span> MutablePropertyValues ?</span><br><span class="line">                                        ((MutablePropertyValues) pvs).getPropertyValueList() : Arrays.asList(pvs.getPropertyValues()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ignoreUnknown) &#123;</span><br><span class="line">    <span class="built_in">this</span>.suppressNotWritablePropertyException = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (PropertyValue pv : propertyValues) &#123;</span><br><span class="line">      <span class="comment">// setPropertyValue may throw any BeansException, which won&#x27;t be caught</span></span><br><span class="line">      <span class="comment">// here, if there is a critical failure such as no matching field.</span></span><br><span class="line">      <span class="comment">// We can attempt to deal only with less serious exceptions.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        setPropertyValue(pv);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (NotWritablePropertyException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ignoreUnknown) &#123;</span><br><span class="line">          <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, just ignore it and continue...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (NullValueInNestedPathException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ignoreInvalid) &#123;</span><br><span class="line">          <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, just ignore it and continue...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (PropertyAccessException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (propertyAccessExceptions == <span class="literal">null</span>) &#123;</span><br><span class="line">          propertyAccessExceptions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        propertyAccessExceptions.add(ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ignoreUnknown) &#123;</span><br><span class="line">      <span class="built_in">this</span>.suppressNotWritablePropertyException = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we encountered individual exceptions, throw the composite exception.</span></span><br><span class="line">  <span class="keyword">if</span> (propertyAccessExceptions != <span class="literal">null</span>) &#123;</span><br><span class="line">    PropertyAccessException[] paeArray = propertyAccessExceptions.toArray(<span class="keyword">new</span> <span class="title class_">PropertyAccessException</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyBatchUpdateException</span>(paeArray);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义Converter原理"><a href="#自定义Converter原理" class="headerlink" title="自定义Converter原理"></a>自定义Converter原理</h4><p>使用<strong>WebMVC</strong>拓展的方式添加&#x2F;修改配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3281050128601582429L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebConfig</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFormatters</span><span class="params">(FormatterRegistry registry)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>WebMvcConfigurer</code>实现<code>addFormatters</code>方法添加<code>Converter</code></p>
<p>使用<code>FormattersRegister</code>提供的<code>addConverter</code>方法来添加</p>
<p><code>String source</code>这是前端传过来的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3281050128601582429L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebConfig</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFormatters</span><span class="params">(FormatterRegistry registry)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;registry&quot;</span>);</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> <span class="title class_">Converter</span>&lt;String, Pet&gt;() &#123;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> Pet <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如前端传了个<code>name=xxx,xxx,xxx</code>，其中<code>xxx,xxx,xxx</code>是数组，你需要根据你规定规则来进行解析，例如有这么一个实体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">2248757905577331865L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pet</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pet</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>name</code>是数组的第一位，<code>age</code>是数组的第二位，而程序是不知道你的规则的，需要你自定义<code>Converter</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Pet <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isEmpty(source)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="type">Pet</span> <span class="variable">pet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pet</span>();</span><br><span class="line">  String[] split = source.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">  pet.setName(split[<span class="number">0</span>]);</span><br><span class="line">  pet.setAge(split[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">return</span> pet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="数据响应与内容协商"><a href="#数据响应与内容协商" class="headerlink" title="数据响应与内容协商"></a>数据响应与内容协商</h3><p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049041.png" alt="数据响应流程"></p>
<h4 id="响应JSON"><a href="#响应JSON" class="headerlink" title="响应JSON"></a>响应JSON</h4><p>如果想要响应JSON，可以使用web场景</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>web场景默认帮我们引入了<code>json</code>场景<code>spring-boot-starter-json</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当然，有了以上场景就不代表我们每个请求都有了处理JSON的能力，需要配合<code>@ResponseBody</code>来进行使用。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseBodyController</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3392266298591310673L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ResponseBodyController</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/get-person&quot;)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> Person <span class="title function_">getPerson</span><span class="params">()</span> &#123;</span><br><span class="line">		String[] likes = &#123;<span class="string">&quot;女&quot;</span>&#125;;</span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    <span class="type">Pet</span> <span class="variable">pet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pet</span>();</span><br><span class="line">    pet.setName(<span class="string">&quot;小黄&quot;</span>);</span><br><span class="line"></span><br><span class="line">    person.setAge(<span class="number">18</span>);</span><br><span class="line">    person.setInterest(likes);</span><br><span class="line">    person.setName(<span class="string">&quot;UpYou&quot;</span>);</span><br><span class="line">    person.setPet(pet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> person;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="返回值解析器"><a href="#返回值解析器" class="headerlink" title="返回值解析器"></a>返回值解析器</h5><p>在<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod()</code>方法中，使用返回值解析起来解析我们方法的返回值。</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049264.png" alt="返回值解析器"></p>
<p>在<code>org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle()</code>方法中执行目标方法，得到该方法的返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br></pre></td></tr></table></figure>

<p>若返回值不是一个<strong>String&#x2F;null</strong>类型，则使用<code>this.returnValueHandlers.handleReturnValue</code>方法来进行处理返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">      returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br></pre></td></tr></table></figure>

<p>断点走到<code>this.returnValueHandlers.handleReturnValue</code>方法中…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                              ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">HandlerMethodReturnValueHandler</span> <span class="variable">handler</span> <span class="operator">=</span> selectHandler(returnValue, returnType);</span><br><span class="line">  <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());</span><br><span class="line">  &#125;</span><br><span class="line">  handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>selectHandler</code>来获取受支持的返回值处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HandlerMethodReturnValueHandler</span> <span class="variable">handler</span> <span class="operator">=</span> selectHandler(returnValue, returnType);</span><br></pre></td></tr></table></figure>

<p>走到<code>selectHandler</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HandlerMethodReturnValueHandler <span class="title function_">selectHandler</span><span class="params">(<span class="meta">@Nullable</span> Object value, MethodParameter returnType)</span> &#123;</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">isAsyncValue</span> <span class="operator">=</span> isAsyncReturnValue(value, returnType);</span><br><span class="line">  <span class="keyword">for</span> (HandlerMethodReturnValueHandler handler : <span class="built_in">this</span>.returnValueHandlers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handler.supportsReturnType(returnType)) &#123;</span><br><span class="line">      <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查是否为异步返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">isAsyncValue</span> <span class="operator">=</span> isAsyncReturnValue(value, returnType);</span><br></pre></td></tr></table></figure>

<p>遍历每个返回值处理器，检查哪个支持这种返回值类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (HandlerMethodReturnValueHandler handler : <span class="built_in">this</span>.returnValueHandlers) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (handler.supportsReturnType(returnType)) &#123;</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若是异步返回值，SpringBoot为提供能为其处理的处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断当前返回值处理器是否支持当前返回值，若当前处理器能够处理，则将其返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler.supportsReturnType(returnType)</span><br></pre></td></tr></table></figure>

<p>拿到支持的处理器之后，调用该处理器的<code>handleReturnValue</code>方法处理返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br></pre></td></tr></table></figure>

<p>最终找到了<code>RequestResponseBodyMthodProcessor</code>。这个返回值解析器支持解析被标注了<code>@ResponseBody</code>的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                              ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span><br><span class="line">  <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line"></span><br><span class="line">  mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">ServletServerHttpRequest</span> <span class="variable">inputMessage</span> <span class="operator">=</span> createInputMessage(webRequest);</span><br><span class="line">  <span class="type">ServletServerHttpResponse</span> <span class="variable">outputMessage</span> <span class="operator">=</span> createOutputMessage(webRequest);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class="line">  writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿到返回值解析器之后，使用消息转换器进行输出到浏览器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br></pre></td></tr></table></figure>

<p>在这个方法中，通过请求头<code>Accept</code> 匹配服务端能不能生产浏览器能处理的内容，浏览器通过指定请求头发送浏览器能处理的类型，其中<code>*/*</code>表示所有内容都能尝试处理。服务器会根据浏览器能处理的数据类型进行匹配，如果找到多个能处理的类型，则通过浏览器提供的类型权重进行匹配。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">writeWithMessageConverters</span><span class="params">(<span class="meta">@Nullable</span> T value, MethodParameter returnType,</span></span><br><span class="line"><span class="params">			ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049460.png" alt="浏览器能支持的内容"></p>
<h4 id="消息转换器原理（HttpMssageConverter）"><a href="#消息转换器原理（HttpMssageConverter）" class="headerlink" title="消息转换器原理（HttpMssageConverter）"></a>消息转换器原理（HttpMssageConverter）</h4><h5 id="MessageConverter-规范"><a href="#MessageConverter-规范" class="headerlink" title="MessageConverter 规范"></a>MessageConverter 规范</h5><p><code>HttpMessageConverter</code>是一个规范消息转换器的一个接口</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049533.png" alt="HttpMssageConverter规范"></p>
<p><code>canRead</code>方法检查当前转换器是否能支持读取这个类型</p>
<p><code>canWrite</code>检查当前转换器是否支持写入这种类型</p>
<h5 id="默认MessageConverter"><a href="#默认MessageConverter" class="headerlink" title="默认MessageConverter"></a>默认MessageConverter</h5><p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049700.png" alt="SpringBoot默认的MessageConverter"></p>
<ol start="0">
<li><p>只支持Byte类型</p>
</li>
<li><p>只支持String类型</p>
</li>
<li><p>只支持String类型</p>
</li>
<li><p>只支持Resource类型</p>
</li>
<li><p>只支持ResourceRegion类型</p>
</li>
<li><p>Source支持以下类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DOMSource.class</span><br><span class="line">SAXSource.class</span><br><span class="line">StAXSource.class</span><br><span class="line">StreamSource.class</span><br><span class="line">Source.class</span><br></pre></td></tr></table></figure>
</li>
<li><p>AllEncompassing只支持MultiValueMap类型</p>
</li>
<li><p>支持所有类型，也就是<code>*/*</code></p>
</li>
<li><p>同上</p>
</li>
<li><p>支持注解XmlRootElement方式的xml</p>
</li>
</ol>
<p>当拿到匹配的转换器后，调用转换器中的<code>write</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="keyword">final</span> T t, <span class="meta">@Nullable</span> <span class="keyword">final</span> Type type, <span class="meta">@Nullable</span> MediaType contentType,</span></span><br><span class="line"><span class="params">                        HttpOutputMessage outputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> outputMessage.getHeaders();</span><br><span class="line">  addDefaultHeaders(headers, t, contentType);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (outputMessage <span class="keyword">instanceof</span> StreamingHttpOutputMessage) &#123;</span><br><span class="line">    <span class="type">StreamingHttpOutputMessage</span> <span class="variable">streamingOutputMessage</span> <span class="operator">=</span> (StreamingHttpOutputMessage) outputMessage;</span><br><span class="line">    streamingOutputMessage.setBody(outputStream -&gt; writeInternal(t, type, <span class="keyword">new</span> <span class="title class_">HttpOutputMessage</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> OutputStream <span class="title function_">getBody</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> outputStream;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    writeInternal(t, type, outputMessage);</span><br><span class="line">    outputMessage.getBody().flush();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前转换器是一个支持Json的转换器，所以数据返回值时需要将请求头设置为<code>content-type: &#39;application/json&#39;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> outputMessage.getHeaders();</span><br><span class="line">addDefaultHeaders(headers, t, contentType);</span><br></pre></td></tr></table></figure>

<p>最后调用<code>writeInternal</code>方法，将返回数据写出去。</p>
<p>在<code>writeInternal</code>中，<code>objectWriter.writeValue</code>将数据转为json，<code>generator.flush();</code>将数据写到<code>outputMessage</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objectWriter.writeValue(generator, value);</span><br><span class="line">writeSuffix(generator, object);</span><br><span class="line">generator.flush();</span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049909.png" alt="flush之后的Response"></p>
<h4 id="内容协商"><a href="#内容协商" class="headerlink" title="内容协商"></a>内容协商</h4><blockquote>
<p>根据客户端的接收能力不同，返回不同媒体类型的数据</p>
</blockquote>
<h5 id="引入xml依赖"><a href="#引入xml依赖" class="headerlink" title="引入xml依赖"></a>引入xml依赖</h5><p><strong>千万别指定版本，启动会报错</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;version&gt;2.12.3&lt;/version&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="测试返回json和xml"><a href="#测试返回json和xml" class="headerlink" title="测试返回json和xml"></a>测试返回json和xml</h5><p>只需要改变请求头中Accept字段，该字段是http协议中规定的，用于告诉服务器当前客户端可以接受处理的数据类型。</p>
<h5 id="内容协商-1"><a href="#内容协商-1" class="headerlink" title="内容协商"></a>内容协商</h5><p>主要逻辑在<code>org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters</code>方法中</p>
<ol>
<li><p>检查当前响应头中是否已经有媒体类型<code>MediaType</code>，这个媒体类型可能是在自定义拦截器中被设置的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MediaType</span> <span class="variable">selectedMediaType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">MediaType</span> <span class="variable">contentType</span> <span class="operator">=</span> outputMessage.getHeaders().getContentType();</span><br></pre></td></tr></table></figure>


</li>
<li><p>获取客户端支持的类型，也就是请求头<code>Accept</code>中的内容例如<code>application/xml</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MediaType&gt; acceptableTypes = getAcceptableMediaTypes(request);</span><br></pre></td></tr></table></figure>


</li>
<li><p>循环当前系统所有的<code>MessageConverter</code>，检查哪个支持解析当前返回值类型。最后将这些支持的媒体类型进行统计</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MediaType&gt; producibleTypes = getProducibleMediaTypes(request, valueType, targetType);</span><br></pre></td></tr></table></figure>


</li>
<li><p>匹配处理当前返回值最佳的<code>MessageConverter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MediaType&gt; mediaTypesToUse = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (MediaType requestedType : acceptableTypes) &#123;</span><br><span class="line">   <span class="keyword">for</span> (MediaType producibleType : producibleTypes) &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestedType.isCompatibleWith(producibleType)) &#123;</span><br><span class="line">         mediaTypesToUse.add(getMostSpecificMediaType(requestedType, producibleType));</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>将匹配出来的<code>MessageConverter</code>进行排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MediaType.sortBySpecificityAndQuality(mediaTypesToUse);</span><br></pre></td></tr></table></figure>


</li>
<li><p>进行最佳匹配，最后拿到的只能有一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (MediaType mediaType : mediaTypesToUse) &#123;</span><br><span class="line">  <span class="keyword">if</span> (mediaType.isConcrete()) &#123;</span><br><span class="line">    selectedMediaType = mediaType;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (mediaType.isPresentIn(ALL_APPLICATION_MEDIA_TYPES)) &#123;</span><br><span class="line">    selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>最后再进行内容协商的最佳匹配，再使用匹配出来的最佳converter，再调用它进行转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="built_in">this</span>.messageConverters) &#123;</span><br><span class="line">  <span class="type">GenericHttpMessageConverter</span> <span class="variable">genericConverter</span> <span class="operator">=</span> (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter ?</span><br><span class="line">                                                  (GenericHttpMessageConverter&lt;?&gt;) converter : <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">if</span> (genericConverter != <span class="literal">null</span> ?</span><br><span class="line">      ((GenericHttpMessageConverter) converter).canWrite(targetType, valueType, selectedMediaType) :</span><br><span class="line">      converter.canWrite(valueType, selectedMediaType)) &#123;</span><br><span class="line">    body = getAdvice().beforeBodyWrite(body, returnType, selectedMediaType,</span><br><span class="line">                                       (Class&lt;? <span class="keyword">extends</span> <span class="title class_">HttpMessageConverter</span>&lt;?&gt;&gt;) converter.getClass(),</span><br><span class="line">                                       inputMessage, outputMessage);</span><br></pre></td></tr></table></figure>


</li>
<li><p>最后响应出去，就得到了它<br><img src="http://qiniu-note-image.ctong.top/note/images/202112271049978.png" alt="内容协商响应的结果"></p>
</li>
</ol>
<h5 id="开启浏览器参数方式内容协商功能"><a href="#开启浏览器参数方式内容协商功能" class="headerlink" title="开启浏览器参数方式内容协商功能"></a>开启浏览器参数方式内容协商功能</h5><p>为了方便内容协商，开启基于请求参数的内容协商功能。在<code>application.yaml</code>中开启</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="comment"># 开启参数方式的内容协商</span></span><br><span class="line">    <span class="attr">contentnegotiation:</span></span><br><span class="line">      <span class="attr">favor-parameter:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>开启之后只需要通过<code>format</code>参数就能更改返回值类型，例如</p>
<p><code>&#123;&#123;api&#125;&#125;/get-person?format=xml</code></p>
<p><code>&#123;&#123;api&#125;&#125;/get-person?format=xml</code></p>
<p>开启基于参数的内容协商功能之后，底层的内容协商管理器多了一个基于参数的内容协商策略，它只支持两种类型：<code>json</code>和<code>xml</code></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049008.png" alt="内容协商管理器"></p>
<h5 id="自定义MessageConverter"><a href="#自定义MessageConverter" class="headerlink" title="自定义MessageConverter"></a>自定义MessageConverter</h5><blockquote>
<p>若需要自定义任何<code>SpringMVC</code>的配置，去<code>WebMvcAutoConfiguration</code>类中参考</p>
</blockquote>
<h6 id="根据请求头处理的MessageConverter"><a href="#根据请求头处理的MessageConverter" class="headerlink" title="根据请求头处理的MessageConverter"></a>根据请求头处理的MessageConverter</h6><p>若需要添加自定义<code>MessageConverter</code>需要实现<code>WebMvcConfigurer</code>接口中的<code>extendMessageConverters</code>方法，这个方法是用来拓展<code>MessgeConverter</code>的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3281050128601582429L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebConfig</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        converters.add(<span class="keyword">new</span> <span class="title class_">MyConverter</span>());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过往<strong>SpringMVC</strong>提供的<code>List&lt;HttpMessageConverter&lt;?&gt;&gt; converters</code>中添加数据，这是一个<code>MessageConverter</code>集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">converters.add(<span class="keyword">new</span> <span class="title class_">MyConverter</span>());</span><br></pre></td></tr></table></figure>

<p>实现一个<code>MessageConverter</code></p>
<ul>
<li><code>canRead(Class&lt;?&gt; clazz, MediaType mediaType)</code> 是否支持读<ul>
<li>底层通过调用这个方法来判断当前<code>MessageConverter</code>是否支持处理读取</li>
</ul>
</li>
<li><code>canWrite(Type type, Class&lt;?&gt; clazz, MediaType mediaType)</code>是否支持写<ul>
<li>底层通过这个方法判断是否支持处理浏览器支持的类型</li>
</ul>
</li>
<li><code>getSupportedMediaTypes(Class&lt;?&gt; clazz)</code>获取支持的类型<ul>
<li>底层通过请求过来的请求头<code>Accept</code>对比，当前<code>MessageConverter</code>是否支持该类型，例如:<code>application/json</code></li>
</ul>
</li>
<li><code>write(Person person, Type type, MediaType contentType, HttpOutputMessage outputMessage)</code>将数据处理并写入<code>outputMessage</code><ul>
<li>如果当前<code>MessageConverter</code>被匹配到了，则用这个<code>MessageConverter</code>处理数据</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyConverter</span> <span class="keyword">implements</span> <span class="title class_">GenericHttpMessageConverter</span>&lt;Person&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(Person person, Type type, MediaType contentType, HttpOutputMessage outputMessage)</span> <span class="keyword">throws</span></span><br><span class="line">    IOException,</span><br><span class="line">  HttpMessageNotWritableException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> person.toString();</span><br><span class="line">    <span class="type">byte</span>[] bytes = data.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    <span class="type">OutputStream</span> <span class="variable">body</span> <span class="operator">=</span> outputMessage.getBody();</span><br><span class="line">    body.write(bytes);</span><br><span class="line">    body.flush();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canRead</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canWrite</span><span class="params">(Type type, Class&lt;?&gt; clazz, MediaType mediaType)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果返回值为Persion，则支持处理</span></span><br><span class="line">    <span class="keyword">return</span> clazz.isAssignableFrom(Person.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;MediaType&gt; <span class="title function_">getSupportedMediaTypes</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> MediaType.parseMediaTypes(<span class="string">&quot;application/c-tong&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意实现的是<code>GenericHttpMessageConverter</code>而不再是<code>HttpMessageConverter</code></p>
<p>我按照教程走，发现我定义的无效，原来是底层改成了<code>GenericHttpMessageConverter</code></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049481.png" alt="匹配MessageConverter代码"></p>
</blockquote>
<p>重新发送请求之后结果就是我们自定义的<code>MessageConverter</code>处理返回的结果</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049488.png" alt="使用自定义MessageConverter处理结果"></p>
<h6 id="根据参数处理的MessageConverter"><a href="#根据参数处理的MessageConverter" class="headerlink" title="根据参数处理的MessageConverter"></a>根据参数处理的MessageConverter</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3281050128601582429L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebConfig</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> &#123; ... &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加<code>strategies</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> &#123;</span><br><span class="line"></span><br><span class="line">  WebMvcConfigurer.<span class="built_in">super</span>.configureContentNegotiation(configurer);</span><br><span class="line">  Map&lt;String, MediaType&gt; mediaTypes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">  mediaTypes.put(<span class="string">&quot;ctong&quot;</span>, MediaType.parseMediaType(<span class="string">&quot;application/c-tong&quot;</span>));</span><br><span class="line">  mediaTypes.put(<span class="string">&quot;json&quot;</span>, MediaType.parseMediaType(<span class="string">&quot;application/json&quot;</span>));</span><br><span class="line">  mediaTypes.put(<span class="string">&quot;xml&quot;</span>, MediaType.parseMediaType(<span class="string">&quot;application/xml&quot;</span>));</span><br><span class="line">  <span class="comment">/// 基于参数的Strategy</span></span><br><span class="line">  <span class="type">ContentNegotiationStrategy</span> <span class="variable">parameterStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParameterContentNegotiationStrategy</span>(mediaTypes);</span><br><span class="line">  <span class="comment">/// 基于请求头的Strategy</span></span><br><span class="line">  <span class="type">HeaderContentNegotiationStrategy</span> <span class="variable">headerStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeaderContentNegotiationStrategy</span>();</span><br><span class="line"></span><br><span class="line">  List&lt;ContentNegotiationStrategy&gt; strategy = Arrays.asList(parameterStrategy, headerStrategy);</span><br><span class="line">  <span class="comment">/// 全部添加到Strategies</span></span><br><span class="line">  configurer.strategies(strategy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有添加<code>Header</code>的<code>MessageConverter</code>，则无法根据请求头中的<code>Aeecpt</code>进行匹配，最后无论<code>Aeecpt</code>是什么，都将当作<code>*/*</code>来进行使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HeaderContentNegotiationStrategy</span> <span class="variable">headerStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeaderContentNegotiationStrategy</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果我们添加了自定义的功能，则可能会将SpringBoot底层定义好的功能覆盖，导致默认功能失效。</p>
</blockquote>
<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>处理请求时，若是需要判断用户是否登录，若是没有登录，就禁止用户访问。这种操作可以使用拦截器来处理，或者也可以使用原生servlet的filter来处理。</p>
<p>在SpringBoot中，<code>HandlerInterceptor</code>是请求拦截器接口，它有三个方法可实现</p>
<ol>
<li><code>preHandle</code> 预先处理</li>
<li><code>postHandle</code>目标方法执行完成后处理</li>
<li><code>afterCompletion</code> 页面渲染后处理</li>
</ol>
<h3 id="定义拦截器"><a href="#定义拦截器" class="headerlink" title="定义拦截器"></a>定义拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, HandlerInterceptor &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7221439597788131747L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">LoginInterceptor</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">    <span class="comment">// 是否登录</span></span><br><span class="line">    <span class="keyword">return</span> session.getAttribute(<span class="string">&quot;loginUser&quot;</span>) != <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义拦截器后，需要将拦截器放到容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, WebMvcConfigurer &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">4663219618421154965L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">WebConfig</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">    registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">      .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">      .excludePathPatterns(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/login.html&quot;</span>,<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/fonts/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>);</span><br><span class="line">    WebMvcConfigurer.<span class="built_in">super</span>.addInterceptors(registry);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>addPathPatterns</code> 过滤路径，<code>/**</code>表示过滤所有路径</li>
<li><code>excludePathPatterns</code> 放行路径，对指定的路径进行放行，也就是不拦截。</li>
</ul>
<h3 id="拦截器原理"><a href="#拦截器原理" class="headerlink" title="拦截器原理"></a>拦截器原理</h3><p>当发送一个请求到服务端后，spring的<code>org.springframework.web.servlet.DispatcherServlet#doDispatch</code>方法会根据这个请求进行匹配一个<strong>HandlerExecutionChain</strong>。里面包含了可以处理当前请求的handler，其中有一个interceptorList属性，它是一个拦截器链。可以看到，spring中有两个默认拦截器，而<code>LoginInterceptor</code>是我们自定义的拦截器。</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049629.png" alt="截屏2021-07-02 下午3.46.37"></p>
<p>在<code>org.springframework.web.servlet.DispatcherServlet#doDispatch</code>中有这么几行代码。<code> mappedHandler.applyPreHandle</code> 执行所有拦截器的<code>preHandler</code>方法，<code>ha.handle</code>是执行执行目标方法，<code>applyPostHandle</code>是执行所有拦截器中的<code>postHandle</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actually invoke the handler.</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br></pre></td></tr></table></figure>

<p>在<code>mappedHandler.applyPreHandle</code>方法中，通过循环容器中的所有拦截器，并执行所有<code>preHandler()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.interceptorList.size(); i++) &#123;</span><br><span class="line">    <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">    <span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">      triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.interceptorIndex = i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>org.springframework.web.servlet.HandlerExecutionChain#applyPreHandle</code></p>
</blockquote>
<p>如果有拦截器没有放行，则会调用<code>triggerAfterCompletion(request, response, null);</code>方法，这个方法中会执行所有已经执行<code>preHandler</code>的拦截器中的<code>afterCompletion()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">triggerAfterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Exception ex)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorIndex; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      interceptor.afterCompletion(request, response, <span class="built_in">this</span>.handler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex2) &#123;</span><br><span class="line">      logger.error(<span class="string">&quot;HandlerInterceptor.afterCompletion threw exception&quot;</span>, ex2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>org.springframework.web.servlet.HandlerExecutionChain#triggerAfterCompletion</code></p>
</blockquote>
<p>当目标方法执行完毕之后也就是<code>ha.handle</code>方法执行完毕后开始执行<code>mappedHandler.applyPostHandle</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span></span><br><span class="line">  <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">    interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>org.springframework.web.servlet.HandlerExecutionChain#applyPostHandle</code></p>
</blockquote>
<p>值得注意的是，无论请求发生任何异常，都会执行所有已执行拦截器的<code>afterCompletion</code></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049188.png" alt="截屏2021-07-02 下午5.02.17"></p>
<p>当请求执行结束后，执行所有已执行拦截器的<code>afterCompletion</code></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049191.png" alt="截屏2021-07-02 下午11.00.16"></p>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>若需要上传文件，请求头中的<code>Content-Type</code>必须为<code>multipart/form-data</code>。可以使用<code>@RequestPart</code>解析<code>multipart/form-data</code>中的参数，<code>@RequestParam</code>也可以完成此操作。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">role</span>=<span class="string">&quot;form&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/upload&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;exampleInputEmail1&quot;</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;exampleInputEmail1&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Enter email&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;exampleInputPassword1&quot;</span>&gt;</span>名字<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;exampleInputPassword1&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;exampleInputFile&quot;</span>&gt;</span>头像<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;headerImg&quot;</span> <span class="attr">id</span>=<span class="string">&quot;exampleInputFile&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;exampleInputFile&quot;</span>&gt;</span>生活照<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;photos&quot;</span> <span class="attr">multiple</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;checkbox&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&gt;</span> Check me out</span><br><span class="line">    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;email&quot;)</span> String email,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestParam(&quot;userName&quot;)</span> String userName,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestPart(&quot;headerImg&quot;)</span> MultipartFile headerImg,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestPart(&quot;photos&quot;)</span> MultipartFile[] photos)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  log.info(<span class="string">&quot;上传的信息：email=&#123;&#125;, userName=&#123;&#125;, headerImg=&#123;&#125;, photos=&#123;&#125;&quot;</span>,</span><br><span class="line">           email, userName, headerImg.getSize(), photos.length);</span><br><span class="line">  <span class="type">String</span> <span class="variable">srcPath</span> <span class="operator">=</span> <span class="string">&quot;/Users/ctong/Desktop/&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 保存图片到本地</span></span><br><span class="line">  <span class="keyword">if</span> (!headerImg.isEmpty()) &#123;</span><br><span class="line">    headerImg.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(srcPath+headerImg.getOriginalFilename()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (photos.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (MultipartFile photo : photos) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!photo.isEmpty()) &#123;</span><br><span class="line">        photo.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(srcPath + photo.getOriginalFilename()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;/index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你上传的图片大小超过了默认的<code>1MB</code>就会出现以下错误。需要在<strong>application.yaml配置文件</strong>中自定义文件大小</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Servlet.service() <span class="keyword">for</span> servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.web.multipart.MaxUploadSizeExceededException: Maximum upload size exceeded; nested exception is java.lang.IllegalStateException: org.apache.tomcat.util.http.fileupload.impl.FileSizeLimitExceededException: The field photos exceeds its maximum permitted size of <span class="number">1048576</span> bytes.] with root cause</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">10MB</span></span><br></pre></td></tr></table></figure>



<h3 id="文件上传原理"><a href="#文件上传原理" class="headerlink" title="文件上传原理"></a>文件上传原理</h3><p>文件上传自动配置类 &#x3D;&gt; <code>org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration</code></p>
<ul>
<li><p>在<code>org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration#multipartResolver</code>中自动配置好了文件上传解析器「<strong>StandardServletMultipartResolver</strong>」。</p>
</li>
<li><p>在<code>org.springframework.web.servlet.DispatcherServlet#doDispatch</code>方法中判断当前请求是否是文件上传请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">processedRequest = checkMultipart(request);</span><br></pre></td></tr></table></figure>

<p>在<code>checkMultipart</code>中通过判断请求头的<code>ContentType</code>是否为<code>multipart/</code>开头，如果是则当前请求为文件上传请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMultipart</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> StringUtils.startsWithIgnoreCase(request.getContentType(), <span class="string">&quot;multipart/&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>org.springframework.web.multipart.support.StandardServletMultipartResolver#isMultipart</code></p>
</blockquote>
<p>最后通过<code>this.multipartResolver.resolveMultipart(request);</code>封装一个<code>MultipartHttpServletRequest</code></p>
<blockquote>
<p><code>org.springframework.web.multipart.support.StandardServletMultipartResolver#resolveMultipart</code></p>
</blockquote>
<p><code>checkMultipart</code>完成后判断<code>processedRequest</code>和<code>request</code>是否相等，如果不相等则视为文件上传请求。因为在<code>checkMultipart</code>方法中，如果是一个文件上传请求，他会将request包装成一个<strong>StandardServletMultipartResolver</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multipartRequestParsed = (processedRequest != request);</span><br></pre></td></tr></table></figure>


</li>
<li><p>通过<code>org.springframework.web.multipart.support.MultipartResolutionDelegate#resolveMultipartArgument</code> 获取<code>MultiValueMap&lt;String, MultipartFile&gt;</code>中的参数。这个<strong>Map</strong>在一开始解析文件上传请求的时候就已经将文件流封装为<code>MultipartFile</code>保存在<code>MultiValueMap</code>中，而<code>RequestPartMethodArgumentResolver</code>解析器只是负责从<code>MultiValueMap</code>中把参数拿出来。</p>
</li>
</ul>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><ul>
<li><p>默认情况下，SpringBoot提供<code>/error</code>处理所有错误的映射</p>
</li>
<li><p>对于机器客户端，它将生成JSON响应，其中包含错误Http状态和异常消息的详细信息，对于浏览器客户端，则响应一个<strong>whitelabel</strong>错误视图，以HTML格式呈现相同的数据。<br><img src="http://qiniu-note-image.ctong.top/note/images/202112271049199.png" alt="截屏2021-07-03 下午4.49.23"></p>
</li>
<li><p>要对其进行自定义，需要添加<code>View</code>解析为<code>error</code><br>要完全替换默认行为，可以实现<code>ErrorController</code>并注册该类型的Bean定义，或添加<code>ErrorAttributes</code>类型的组件以使用现有机制替换其内容。</p>
</li>
<li><p><code>error/</code>下的4xx、5xx页面会被自动解析<br><img src="http://qiniu-note-image.ctong.top/note/images/202112271049536.png" alt="截屏2021-07-03 下午4.53.08"></p>
</li>
</ul>
<h3 id="定制错误处理"><a href="#定制错误处理" class="headerlink" title="定制错误处理"></a>定制错误处理</h3><ul>
<li>自定义错误页<ul>
<li>error&#x2F;404.html</li>
<li>error&#x2F;5xx.html</li>
</ul>
</li>
<li>@ControllerAdvice + @ExceptionHandler处理异常</li>
<li>实现Handler Exception Resolver处理异常</li>
</ul>
<h3 id="异常处理自动配置原理"><a href="#异常处理自动配置原理" class="headerlink" title="异常处理自动配置原理"></a>异常处理自动配置原理</h3><p>自动配置异常处理规则在这个类中<code>org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</code> </p>
<p>这个类就是一个普通的<code>Controller</code>，如果没有在配置文件中指定错误路径<code>server.error.path</code>，那么则使用默认的错误路径<code>/error</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicErrorController</span> <span class="keyword">extends</span> <span class="title class_">AbstractErrorController</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在这个类中，有两个方法响应这个请求</p>
<ol>
<li><p><code>org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController#error</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(produces = MediaType.TEXT_HTML_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">  <span class="type">HttpStatus</span> <span class="variable">status</span> <span class="operator">=</span> getStatus(request);</span><br><span class="line">  Map&lt;String, Object&gt; model = Collections</span><br><span class="line">    .unmodifiableMap(getErrorAttributes(request, getErrorAttributeOptions(request, MediaType.TEXT_HTML)));</span><br><span class="line">  response.setStatus(status.value());</span><br><span class="line">  <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> resolveErrorView(request, response, status, model);</span><br><span class="line">  <span class="keyword">return</span> (modelAndView != <span class="literal">null</span>) ? modelAndView : <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;error&quot;</span>, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果当前请求是普通浏览器客户端，则使用这个方法处理，否则使用下面那个方法。当一个请求过来的时候，通过<code>resolveErrorView</code>方法获取视图解析器，默认解析器只有一个<code>DefaultErrorViewResolver</code>，而在这个视图解析器中通过<code>org.springframework.boot.autoconfigure.web.servlet.error.DefaultErrorViewResolver#resolve</code>方法得到一个视图，在这个方法内部，已经钉死了模版位置</p>
<p><code>String errorViewName = &quot;error/&quot; + viewName;</code></p>
<p>下一步获取可解析这个模板的模板解析器<code>this.templateAvailabilityProviders.getProvider</code>如果在这一步找不到可以解析这个模板的解析器，那么则返回一个可以通过<strong>html</strong>解析器进行解析的<code>ModelAndView</code>。</p>
<blockquote>
<p>这个<code>ModelAndView</code>并不是一个真正的视图，它是一个视图“模型”</p>
</blockquote>
<p>得到这些信息之后，其它步骤就是普通的解析。</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049663.png" alt="截屏2021-07-05 21.45.01"></p>
</li>
<li><p><code>org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController#mediaTypeNotAcceptable</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">error</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">  <span class="type">HttpStatus</span> <span class="variable">status</span> <span class="operator">=</span> getStatus(request);</span><br><span class="line">  <span class="keyword">if</span> (status == HttpStatus.NO_CONTENT) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(status);</span><br><span class="line">  &#125;</span><br><span class="line">  Map&lt;String, Object&gt; body = getErrorAttributes(request, getErrorAttributeOptions(request, MediaType.ALL));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(body, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个其实和第一个一样，只不过返回类型变成一个普通的实体<code>ResponseEntity</code>，这个试图最终会以JSON的形式展示。</p>
<h3 id="异常处理流程"><a href="#异常处理流程" class="headerlink" title="异常处理流程"></a>异常处理流程</h3><p><strong>“没搞清楚&#x2F;error在哪转定义”</strong></p>
<h2 id="Web原生组件注入（Servlet、Filter、Listener）"><a href="#Web原生组件注入（Servlet、Filter、Listener）" class="headerlink" title="Web原生组件注入（Servlet、Filter、Listener）"></a>Web原生组件注入（Servlet、Filter、Listener）</h2><h3 id="使用ServletApi"><a href="#使用ServletApi" class="headerlink" title="使用ServletApi"></a>使用ServletApi</h3><p>spring boot支持原生servlet的<code>@WebFilter</code>、<code>@WebServlet</code> 、<code>@WebListener</code>，它需要通过<code>@ServletComponentScan</code>注解对指定包进行扫描。</p>
<h4 id="WebServlet"><a href="#WebServlet" class="headerlink" title="@WebServlet"></a>@WebServlet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/my&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">MyServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">      writer.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意，使用原生Servlet之后，无法被SpringBoot的拦截器所拦截</strong></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049875.png" alt="截屏2021-07-08 14.48.34"></p>
<h4 id="WebFilter"><a href="#WebFilter" class="headerlink" title="@WebFilter"></a>@WebFilter</h4><p>使用原生servlet的filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;原生过滤器初始化&quot;</span>);</span><br><span class="line">        Filter.<span class="built_in">super</span>.init(filterConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;原生过滤器开始执行&quot;</span>);</span><br><span class="line">        <span class="comment">/// 放行</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;原生过滤器销毁&quot;</span>);</span><br><span class="line">        Filter.<span class="built_in">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>原生servlet的filter也无法拦截spring boot的请求</strong></p>
<h4 id="WebListener"><a href="#WebListener" class="headerlink" title="@WebListener"></a>@WebListener</h4><p>监听servlet是否启动成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServletContextListener</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">MyServletContextListener</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;MyServletContextListener监听到项目初始化完成&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;MyServletContextListener监听到项目被销毁&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="ServletComponentScan"><a href="#ServletComponentScan" class="headerlink" title="@ServletComponentScan"></a>@ServletComponentScan</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServletComponentScan(basePackages = &quot;com.ctong.learnspringboot&quot;)</span> <span class="comment">// 指定包进行扫描，将原生Servlet注入到Spring</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LearnSpringBootApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      SpringApplication.run(LearnSpringBootApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="使用RegistrationBean"><a href="#使用RegistrationBean" class="headerlink" title="使用RegistrationBean"></a>使用RegistrationBean</h3><p>除了通过<code>@WebServlet</code>、<code>@WebFilter</code>、<code>@WebListener</code>外，Springboot还提供了它自己的注册方式，<code>ServletRegistrationBean</code>、<code>FilterRegistrationBean</code>、<code>ServletListenerRegistrationBean</code>。使用<code>RegistrationBean</code>无需通过<code>ServletComponentScan</code>进行扫描，因为它本身就是一个<code>Component</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRegisterConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">MyRegisterConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SpringBoot提供的多种原生Servlet注入方式之一</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServletRegistrationBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> ServletRegistrationBean&lt;MyServlet&gt; <span class="title function_">servletRegistrationBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MyServlet</span> <span class="variable">myServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyServlet</span>();</span><br><span class="line">    <span class="comment">// ServletRegistrationBean 第一个参数代表需要注入的servlet， 第二个参数是一个数组，表示这些url都通过这个servlet进行处理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>&lt;&gt;(myServlet, <span class="string">&quot;/my&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SpringBoot 提供的多种原生Filter注入方式之一</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FilterRegistrationBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> FilterRegistrationBean&lt;MyFilter&gt; <span class="title function_">filterRegistrationBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MyFilter</span> <span class="variable">myFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyFilter</span>();</span><br><span class="line">    <span class="comment">// 拦截指定servlet</span></span><br><span class="line">    FilterRegistrationBean&lt;MyFilter&gt; filter = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;(myFilter, servletRegistrationBean());</span><br><span class="line">    List&lt;String&gt; patterns = Arrays.asList(<span class="string">&quot;/css/*&quot;</span>, <span class="string">&quot;/js/*&quot;</span>, <span class="string">&quot;/fonts/*&quot;</span>, <span class="string">&quot;/images/*&quot;</span>);</span><br><span class="line">    filter.setUrlPatterns(patterns);</span><br><span class="line">    <span class="keyword">return</span> filter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SpringBoot 提供的多种原生Listener注入方式之一</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServletListenerRegistrationBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> ServletListenerRegistrationBean&lt;MyServletContextListener&gt; <span class="title function_">servletContextListenerRegistrationBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MyServletContextListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyServletContextListener</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletListenerRegistrationBean</span>&lt;&gt;(listener);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在SpringBoot底层中，也是通过原生Servlet进行编写，StringBoot中默认Servlet处理的路径是<code>/</code>，源码在<code>org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration.DispatcherServletConfiguration#dispatcherServlet</code>。</p>
<p>其实和我们注入原生Servlet是一样的<code>org.springframework.web.servlet.DispatcherServlet#doService</code>，他这个<code>doService</code>等价于<code>javax.servlet.http.HttpServlet#service(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse)</code>方法</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049332.png" alt="Shot_20210708_153831"></p>
<p>在tomcat中，若是存在多个servlet，它会进行<strong>精确匹配</strong>，例如有两个servlet，A处理<code>/</code>路径，B处理<code>/my</code>路径。用户端发送一个<code>/my</code>请求过来例如：127.0.0.1:80&#x2F;my&#x2F;login。那么tomcat就会使用B的规则去处理这个请求。</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049327.png" alt="截屏2021-07-08 15.22.34"></p>
<h2 id="嵌入式Servlet容器"><a href="#嵌入式Servlet容器" class="headerlink" title="嵌入式Servlet容器"></a>嵌入式Servlet容器</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.developing-web-applications.embedded-container.application-context">官网文档传送门</a></p>
<h3 id="切换嵌入式Servlet容器"><a href="#切换嵌入式Servlet容器" class="headerlink" title="切换嵌入式Servlet容器"></a>切换嵌入式Servlet容器</h3><p>Spring Boot 内嵌了一个tomcat服务器，除了tomcat，它还支持其它的<code>WebServlet</code>，例如<code>Jetty</code>、<code>Undertow</code>。SpringBoot是通过<code>org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext</code>容器启动并寻找<code>org.springframework.boot.web.servlet.server.ServletWebServerFactory</code></p>
<h3 id="切换servlet服务器"><a href="#切换servlet服务器" class="headerlink" title="切换servlet服务器"></a>切换servlet服务器</h3><p>由于SpringBoot的web场景内嵌了tomcat，所以需要将tomcat剔除然后导入我们需要的servlet服务器。在导入之前，需要排除springboot默认引入的tomcat服务器，因为tomcat服务器的优先级最高。如果不排除会导致我们指定的服务器无法被添加进容器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 排除默认导入的tomcat --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>排除tomcat依赖后导入我们需要的服务器即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 导入undertow服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><ul>
<li>spring boot应用启动发现当前是web应用。web场景包会自动导入tomcat</li>
<li>web应用会创建一个web版的ioc容器<code>org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext</code></li>
<li>当这个容器启动的时候会自动寻找<code>org.springframework.boot.web.servlet.server.ServletWebServerFactory</code></li>
<li>Spring Boot 底层有很多WebServlet工厂：<code>TomcatServletWebServerFactory</code>, <code>JettyServletWebServerFactory</code>, <code>UndertowServletWebServerFactory</code> 他们分别对应<code>tomcat</code>、<code>jetty</code>、<code>undertow</code></li>
<li>在底层有一个自动配置类，里面导入了默认的WebServlet<br><code>org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration</code>。在这个自动配置类中导入了<code>org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryConfiguration</code>配置类，在这个类中动态判断系统中到底导入了哪个个Web服务器的包（默认tomcat）<code>TomcatServletWebServerFactory</code></li>
<li>在<code>org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory</code>中创建出tomcat服务器并启动。</li>
</ul>
<h3 id="定制servlet容器"><a href="#定制servlet容器" class="headerlink" title="定制servlet容器"></a>定制servlet容器</h3><ol>
<li>实现<code>WebServerFactoryCustomizer&lt;ConfigurableServletWebServerFactory&gt;</code>接口，通过<code>customize</code>方法将配置文件的值和<code>ServletWebServerFactory</code>中相关的属性进行绑定。</li>
<li>修改配置文件，<code>server.xxx</code>，与<code>servlet</code>相关的配置都在<code>server.xxx</code>下，具体可以查看<code>org.springframework.boot.autoconfigure.web.ServerProperties</code></li>
<li>添加<code>org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory</code>组件到容器中，这种方式相当于</li>
</ol>
<h2 id="定制化原理"><a href="#定制化原理" class="headerlink" title="定制化原理"></a>定制化原理</h2><h3 id="定制化的常见方式"><a href="#定制化的常见方式" class="headerlink" title="定制化的常见方式"></a>定制化的常见方式</h3><ul>
<li><p>修改配置文件</p>
</li>
<li><p>实现xxx Customizer类</p>
</li>
<li><p>编写自定义的配置类xxxConfiguration，通过<code>@Bean</code>添加或替换容器中默认的组件</p>
</li>
<li><p>web应用实现<code>WebMvcConfiguration</code>即可定制化web功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@EnableWebMvc</code> + <code>WebMvcConfiguration</code>。这种方式将全面接管SpringMvc，所有规则全部自己重新配置。实现定制和功能的拓展</p>
<ul>
<li><p>原理</p>
<ol>
<li><p><code>WebMvcAutoConfiguration</code>是SpringMvc默认的自动配置类，其中配置了静态资源规则、欢迎页等规则…</p>
</li>
<li><p><code>@EnableWebMvc</code>中会导入<code>DelegatingWebMvcConfiguration</code>，它继承了<code>WebMvcConfigurationSupport</code></p>
</li>
<li><p><code>DelegatingWebMvcConfiguration</code>的作用是只保证SpringMvc最基本的使用</p>
<ol>
<li>这个配置类会把系统中所有的<code>WebMvcConfiguration</code>拿过来。所有的功能定制都是这些<code>WebMvcConfiguration</code>合起来的结果</li>
<li>自动配置了一些非常底层的组件。<code>RequestMapping</code>、<code>HandlerMapping</code>，这些组件依赖的组件都是从容器中获取</li>
</ol>
</li>
<li><p>在<code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</code>中，有一个生效条件<code>@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</code>当<code>WebMvcConfigurationSupport.class</code>不存在时生效</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>导入所需场景，例如<code>starter-web</code> -&gt;&gt; </p>
<p>之后这个starter场景会导入xxxAutoConfiguration自动配置类 -&gt;&gt;</p>
<p>在这个自动配置类中会使用@Bean导入一系列组件 -&gt;&gt;</p>
<p>在组件中的默认配置都会跟xxxProperties进行绑定 -&gt;&gt;</p>
<p>最后xxProperties又和配置文件进行绑定</p>
</li>
</ol>
<h2 id="指标监控"><a href="#指标监控" class="headerlink" title="指标监控"></a>指标监控</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints">官网相关文档</a></p>
<h3 id="SpringBoot-Actuator"><a href="#SpringBoot-Actuator" class="headerlink" title="SpringBoot Actuator"></a>SpringBoot Actuator</h3><p>未来每一个微服务在云上部署后，需要对其进行监控、追踪、审计、控制等。SpringBoot就抽取了Actuator场景，使得我门每个微服务快速引用即可获得生产级别的应用监控、审计等功能。</p>
   <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul>
<li><p>引入actuator场景</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/actuator//*/">http://localhost:8080/actuator/\*\</a>*</p>
</li>
<li><p>Web下默认暴露的端点只有<code>health</code>和<code>info</code>，可以在配置中暴露所有端点信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># actuator 监控指标</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">enabled-by-default:</span> <span class="literal">true</span> <span class="comment"># 默认开启所有监控端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span> <span class="comment"># 以web方式暴露所有监控端点</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><p><a target="_blank" rel="noopener" href="https://github.com/codecentric/spring-boot-admin">https://github.com/codecentric/spring-boot-admin</a></p>
<h3 id="Actuator-Endpoint"><a href="#Actuator-Endpoint" class="headerlink" title="Actuator Endpoint"></a>Actuator Endpoint</h3><p>常用的Endpoint有</p>
<ul>
<li>Health<br>监控状况</li>
<li>Metrics<br>运行时指标</li>
<li>Loggers<br>日志记录</li>
</ul>
<h4 id="Health-Endpoint"><a href="#Health-Endpoint" class="headerlink" title="Health Endpoint"></a>Health Endpoint</h4><p>健康检查端点，一般用在云平台，平台会定时检查应用的健康状况。需要Health Endpoint为平台返回当前应用的一系列组件健康状况集合。</p>
<ul>
<li>health endpoint 返回的结果，应该是一系列健康检查后的一个汇总报告</li>
<li>很多的健康检查默认已经自动配好了，比如：数据库，redis等</li>
<li>可以自定义添加健康检查机制</li>
</ul>
<p>开启指定端点详细信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># actuator 监控指标</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span> <span class="comment"># 显示详细</span></span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049555.png" alt="截屏2021-07-14 15.04.50"></p>
<h4 id="Metrics-Endpoint"><a href="#Metrics-Endpoint" class="headerlink" title="Metrics Endpoint"></a>Metrics Endpoint</h4><p>提供详细的、层级的、空间指标信息，这些信息可以被pull（主动推送）或者push（被动获取）方式得到：</p>
<ul>
<li>通过Metrics对接多种监控系统</li>
<li>简化核心Metrics开发</li>
<li>添加自定义Metrics或者扩展已有Metrics</li>
</ul>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049574.png" alt="截屏2021-07-14 15.10.09"></p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049845.png" alt="截屏2021-07-14 15.11.13"></p>
<h3 id="管理Endpoint"><a href="#管理Endpoint" class="headerlink" title="管理Endpoint"></a>管理Endpoint</h3><h4 id="开启与禁用Endpoint"><a href="#开启与禁用Endpoint" class="headerlink" title="开启与禁用Endpoint"></a>开启与禁用Endpoint</h4><p>默认情况下，endpoint是全部开启的，若需要指定开启，需要全部关闭后再开启指定端点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># actuator 监控指标</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">enabled-by-default:</span> <span class="literal">false</span> <span class="comment"># 关闭全部端点</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span> <span class="comment"># 显示详细信息</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启端点</span></span><br><span class="line">    <span class="attr">info:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>





<h3 id="定制Endpoint"><a href="#定制Endpoint" class="headerlink" title="定制Endpoint"></a>定制Endpoint</h3><h4 id="定制Health信息"><a href="#定制Health信息" class="headerlink" title="定制Health信息"></a>定制Health信息</h4><p>实现<code>HealthIndicator</code>接口或者<code>AbstractHealthIndicator</code>抽象类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComponentHealthIndicator</span> <span class="keyword">extends</span> <span class="title class_">AbstractHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">5066467685531996717L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ComponentHealthIndicator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doHealthCheck</span><span class="params">(Health.Builder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">      builder.status(Status.UP);</span><br><span class="line">      map.put(<span class="string">&quot;count&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      map.put(<span class="string">&quot;ms&quot;</span>, <span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder.status(Status.OUT_OF_SERVICE);</span><br><span class="line">      map.put(<span class="string">&quot;err&quot;</span>, <span class="string">&quot;连接超时&quot;</span>);</span><br><span class="line">      map.put(<span class="string">&quot;ms&quot;</span>, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    builder.withDetail(<span class="string">&quot;code&quot;</span>, <span class="number">200</span>).withDetails(map);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049017.png" alt="image-20210714154234818"></p>
<h4 id="定制info信息"><a href="#定制info信息" class="headerlink" title="定制info信息"></a>定制info信息</h4><p>定制info有两种方法，一种是在application.yaml配置文件中定义 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">@project.version@</span> <span class="comment"># 获取pom文件中的版本信息</span></span><br><span class="line">  <span class="attr">autor:</span> <span class="string">Clover</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">19</span></span><br></pre></td></tr></table></figure>

<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049192.png" alt="截屏2021-07-14 15.45.20"></p>
<p>第二种方式，可以实现<code>InfoContributor</code>接口的方式实现，第二种优先级高于配置文件方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppInfoContributor</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, InfoContributor &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2489956740668578470L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">AppInfoContributor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contribute</span><span class="params">(Info.Builder builder)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; info = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    info.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Clover.You&quot;</span>);</span><br><span class="line">    info.put(<span class="string">&quot;age&quot;</span>, <span class="number">19</span>);</span><br><span class="line">    info.put(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0.0.1&quot;</span>);</span><br><span class="line">    builder.withDetails(info);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="定制Metrics信息"><a href="#定制Metrics信息" class="headerlink" title="定制Metrics信息"></a>定制Metrics信息</h4><h5 id="增加定制Metrics"><a href="#增加定制Metrics" class="headerlink" title="增加定制Metrics"></a>增加定制Metrics</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2783841528321793923L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计数指标</span></span><br><span class="line">  <span class="keyword">private</span> Counter counter;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">LoginController</span><span class="params">(MeterRegistry meter)</span> &#123;</span><br><span class="line">    <span class="comment">// 注册自定义计数指标，记录登录方法调用了几次</span></span><br><span class="line">    counter = meter.counter(<span class="string">&quot;com.ctong.learnspringboot.controller.LoginController.login&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(HttpSession session, User user)</span> &#123;</span><br><span class="line">    <span class="comment">// 增加计数</span></span><br><span class="line">    counter.increment();</span><br><span class="line">    session.setAttribute(<span class="string">&quot;loginUser&quot;</span>, user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/index.html&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册成功后，访问localhost:8080&#x2F;actuator&#x2F;metrics就可以看见我们自定义的新指标</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049497.png" alt="image-20210714162110608"></p>
<p>计数会随着<code>counter.increment();</code>方法的调用而增加</p>
<p><img src="http://qiniu-note-image.ctong.top/note/images/202112271049795.png" alt="截屏2021-07-14 16.22.11"></p>
<h4 id="定义Endpoint"><a href="#定义Endpoint" class="headerlink" title="定义Endpoint"></a>定义Endpoint</h4><p>SpringBoot给我们定义了非常多的监控端点，一旦我们引入 了复杂场景，可能需要自定义监控端点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Endpoint(id = &quot;diy&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyEndpoint</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1370368576988354134L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">MyEndpoint</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止存在一个或多个有参构造器时反射通过无参构造起实例化发生异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ReadOperation</span></span><br><span class="line">  <span class="keyword">public</span> Map <span class="title function_">getDockerInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;docker started...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@WriteOperation</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopDocker</span><span class="params">()</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;docker stopped....&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<blockquote>
<p>   SpringBoot由多种解析器组成</p>
</blockquote>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">文件类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#properties"><span class="toc-number">1.1.1.</span> <span class="toc-text">properties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yaml"><span class="toc-number">1.1.2.</span> <span class="toc-text">yaml</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E7%BB%91%E5%AE%9A%E7%9A%84%E9%85%8D%E7%BD%AE%E6%8F%90%E7%A4%BA"><span class="toc-number">1.2.</span> <span class="toc-text">自定义类绑定的配置提示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E5%BC%80%E5%8F%91"><span class="toc-number">2.</span> <span class="toc-text">Web开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">简单功能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">静态资源访问</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">静态资源目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">静态资源访问原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%89%8D%E7%BC%80"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">静态资源访问前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84%E4%BF%AE%E6%94%B9"><span class="toc-number">2.1.1.4.</span> <span class="toc-text">静态资源路径修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E9%A1%B5%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.5.</span> <span class="toc-text">欢迎页配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Favicon"><span class="toc-number">2.1.1.6.</span> <span class="toc-text">Favicon</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.1.7.</span> <span class="toc-text">静态资源配置原理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86%E9%BB%98%E8%AE%A4%E8%A7%84%E5%88%99%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">2.1.1.7.1.</span> <span class="toc-text">资源处理默认规则核心代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E9%A1%B5%E7%9A%84%E5%A4%84%E7%90%86%E8%A7%84%E5%88%99"><span class="toc-number">2.1.1.7.2.</span> <span class="toc-text">欢迎页的处理规则</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">请求参数处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84"><span class="toc-number">3.1.</span> <span class="toc-text">请求映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rest%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">Rest原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.2.</span> <span class="toc-text">请求映射原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%8F%82%E6%95%B0%E4%B8%8E%E5%9F%BA%E6%9C%AC%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">普通参数与基本注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PathVariable"><span class="toc-number">3.2.2.</span> <span class="toc-text">@PathVariable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestHeader"><span class="toc-number">3.2.3.</span> <span class="toc-text">@RequestHeader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestParam"><span class="toc-number">3.2.4.</span> <span class="toc-text">@RequestParam</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CookieValue"><span class="toc-number">3.2.5.</span> <span class="toc-text">@CookieValue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestBody"><span class="toc-number">3.2.6.</span> <span class="toc-text">@RequestBody</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RequestAttribute"><span class="toc-number">3.2.7.</span> <span class="toc-text">@RequestAttribute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MatrixVariable"><span class="toc-number">3.2.8.</span> <span class="toc-text">@MatrixVariable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.9.</span> <span class="toc-text">各种参数类型解析原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.2.10.</span> <span class="toc-text">参数处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.2.11.</span> <span class="toc-text">返回值处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.2.12.</span> <span class="toc-text">执行处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E5%80%BC"><span class="toc-number">3.2.12.1.</span> <span class="toc-text">如何确定目标方法每一个参数值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E8%BF%99%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E5%80%BC"><span class="toc-number">3.2.12.2.</span> <span class="toc-text">解析这个参数的值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet-API"><span class="toc-number">3.3.</span> <span class="toc-text">Servlet API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%8F%82%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">复杂参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A%E5%8E%9F%E7%90%86"><span class="toc-number">3.5.</span> <span class="toc-text">自定义类型参数绑定原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POJO-%E5%B0%81%E8%A3%85%E8%BF%87%E7%A8%8B"><span class="toc-number">3.5.1.</span> <span class="toc-text">POJO 封装过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Converter%E5%8E%9F%E7%90%86"><span class="toc-number">3.5.2.</span> <span class="toc-text">自定义Converter原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86"><span class="toc-number">3.6.</span> <span class="toc-text">数据响应与内容协商</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%8D%E5%BA%94JSON"><span class="toc-number">3.6.1.</span> <span class="toc-text">响应JSON</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">返回值解析器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8%E5%8E%9F%E7%90%86%EF%BC%88HttpMssageConverter%EF%BC%89"><span class="toc-number">3.6.2.</span> <span class="toc-text">消息转换器原理（HttpMssageConverter）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MessageConverter-%E8%A7%84%E8%8C%83"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">MessageConverter 规范</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4MessageConverter"><span class="toc-number">3.6.2.2.</span> <span class="toc-text">默认MessageConverter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86"><span class="toc-number">3.6.3.</span> <span class="toc-text">内容协商</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5xml%E4%BE%9D%E8%B5%96"><span class="toc-number">3.6.3.1.</span> <span class="toc-text">引入xml依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%94%E5%9B%9Ejson%E5%92%8Cxml"><span class="toc-number">3.6.3.2.</span> <span class="toc-text">测试返回json和xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86-1"><span class="toc-number">3.6.3.3.</span> <span class="toc-text">内容协商</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8F%82%E6%95%B0%E6%96%B9%E5%BC%8F%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8A%9F%E8%83%BD"><span class="toc-number">3.6.3.4.</span> <span class="toc-text">开启浏览器参数方式内容协商功能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89MessageConverter"><span class="toc-number">3.6.3.5.</span> <span class="toc-text">自定义MessageConverter</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%A4%84%E7%90%86%E7%9A%84MessageConverter"><span class="toc-number">3.6.3.5.1.</span> <span class="toc-text">根据请求头处理的MessageConverter</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E7%9A%84MessageConverter"><span class="toc-number">3.6.3.5.2.</span> <span class="toc-text">根据参数处理的MessageConverter</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.1.</span> <span class="toc-text">定义拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">拦截器原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">5.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">文件上传原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">6.1.</span> <span class="toc-text">定制错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">异常处理自动配置原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">6.3.</span> <span class="toc-text">异常处理流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E5%8E%9F%E7%94%9F%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%85%A5%EF%BC%88Servlet%E3%80%81Filter%E3%80%81Listener%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">Web原生组件注入（Servlet、Filter、Listener）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ServletApi"><span class="toc-number">7.1.</span> <span class="toc-text">使用ServletApi</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WebServlet"><span class="toc-number">7.1.1.</span> <span class="toc-text">@WebServlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebFilter"><span class="toc-number">7.1.2.</span> <span class="toc-text">@WebFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebListener"><span class="toc-number">7.1.3.</span> <span class="toc-text">@WebListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ServletComponentScan"><span class="toc-number">7.1.4.</span> <span class="toc-text">@ServletComponentScan</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RegistrationBean"><span class="toc-number">7.2.</span> <span class="toc-text">使用RegistrationBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">7.3.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8FServlet%E5%AE%B9%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">嵌入式Servlet容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%B5%8C%E5%85%A5%E5%BC%8FServlet%E5%AE%B9%E5%99%A8"><span class="toc-number">8.1.</span> <span class="toc-text">切换嵌入式Servlet容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2servlet%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.2.</span> <span class="toc-text">切换servlet服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">8.3.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6servlet%E5%AE%B9%E5%99%A8"><span class="toc-number">8.4.</span> <span class="toc-text">定制servlet容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%8C%96%E5%8E%9F%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">定制化原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%8C%96%E7%9A%84%E5%B8%B8%E8%A7%81%E6%96%B9%E5%BC%8F"><span class="toc-number">9.1.</span> <span class="toc-text">定制化的常见方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">9.2.</span> <span class="toc-text">原理分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7"><span class="toc-number">10.</span> <span class="toc-text">指标监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot-Actuator"><span class="toc-number">10.1.</span> <span class="toc-text">SpringBoot Actuator</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">10.1.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">10.1.2.</span> <span class="toc-text">可视化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Actuator-Endpoint"><span class="toc-number">10.2.</span> <span class="toc-text">Actuator Endpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Health-Endpoint"><span class="toc-number">10.2.1.</span> <span class="toc-text">Health Endpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Metrics-Endpoint"><span class="toc-number">10.2.2.</span> <span class="toc-text">Metrics Endpoint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86Endpoint"><span class="toc-number">10.3.</span> <span class="toc-text">管理Endpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E4%B8%8E%E7%A6%81%E7%94%A8Endpoint"><span class="toc-number">10.3.1.</span> <span class="toc-text">开启与禁用Endpoint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6Endpoint"><span class="toc-number">10.4.</span> <span class="toc-text">定制Endpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6Health%E4%BF%A1%E6%81%AF"><span class="toc-number">10.4.1.</span> <span class="toc-text">定制Health信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6info%E4%BF%A1%E6%81%AF"><span class="toc-number">10.4.2.</span> <span class="toc-text">定制info信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6Metrics%E4%BF%A1%E6%81%AF"><span class="toc-number">10.4.3.</span> <span class="toc-text">定制Metrics信息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AE%9A%E5%88%B6Metrics"><span class="toc-number">10.4.3.1.</span> <span class="toc-text">增加定制Metrics</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89Endpoint"><span class="toc-number">10.4.4.</span> <span class="toc-text">定义Endpoint</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=Spring Boot核心功能 - 学习笔记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&is_video=false&description=Spring Boot核心功能 - 学习笔记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Spring Boot核心功能 - 学习笔记&body=Check out this article: http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=Spring Boot核心功能 - 学习笔记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=Spring Boot核心功能 - 学习笔记&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://www.ctong.top/2022/01/02/Spring-Boot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD---%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=Spring Boot核心功能 - 学习笔记"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    Clover You
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
